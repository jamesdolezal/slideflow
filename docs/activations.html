

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Layer activations &mdash; slideflow 1.9.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix" href="appendix.html" />
    <link rel="prev" title="Evaluation" href="evaluation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="root.html" class="icon icon-home" alt="Documentation Home"> slideflow
          

          
          </a>

          
            
            
              <div class="version">
                1.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="project.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation.html">Evaluation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Layer activations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#mosaic-maps">Mosaic maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-activations">Working with activations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="slideflow.html">Source</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="root.html">slideflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="root.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Layer activations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/activations.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="layer-activations">
<h1>Layer activations<a class="headerlink" href="#layer-activations" title="Permalink to this headline">¶</a></h1>
<p>Once a model has been fully trained and evaluated, you may use the model to generate penultimate layer activations to gain better insight into the kinds of image features the model has learned.</p>
<div class="section" id="mosaic-maps">
<h2>Mosaic maps<a class="headerlink" href="#mosaic-maps" title="Permalink to this headline">¶</a></h2>
<p>The easiest way to get started with layer activations is to calculate and display layer activations as a mosaic map. Mosaic maps are generated by calculating penultimate layer activations for a set of tiles (via <a class="reference internal" href="slideflow.html#slideflow.activations.ActivationsVisualizer" title="slideflow.activations.ActivationsVisualizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">slideflow.activations.ActivationsVisualizer</span></code></a>), performing dimensionality reduction (UMAP) on the activations (via <a class="reference internal" href="slideflow.html#slideflow.statistics.TFRecordMap" title="slideflow.statistics.TFRecordMap"><code class="xref py py-class docutils literal notranslate"><span class="pre">slideflow.statistics.TFRecordMap</span></code></a>), and overlaying tile images onto the UMAP (via <a class="reference internal" href="slideflow.html#slideflow.mosaic.Mosaic" title="slideflow.mosaic.Mosaic"><code class="xref py py-class docutils literal notranslate"><span class="pre">slideflow.mosaic.Mosaic</span></code></a>). The <code class="docutils literal notranslate"><span class="pre">SlideflowProject</span></code> class has a function which can supervise these steps automatically and save the final figure to the project directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">SFP</span><span class="o">.</span><span class="n">generate_mosaic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;/path/to/saved/model.h5&quot;</span><span class="p">,</span>
                <span class="n">mosaic_filename</span><span class="o">=</span><span class="s2">&quot;/path/to/destination/mosaic.png&quot;</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evaluation&quot;</span><span class="p">]})</span>
</pre></div>
</div>
<dl class="py function">
<dt>
<code class="sig-prename descclassname">slideflow.SlideflowProject.</code><code class="sig-name descname">generate_mosaic</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">self</span></em>, <em class="sig-param"><span class="n">model</span></em>, <em class="sig-param"><span class="n">mosaic_filename</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">umap_filename</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">outcome_header</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">filters</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">filter_blank</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">focus_filters</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">resolution</span><span class="o">=</span><span class="default_value">'low'</span></em>, <em class="sig-param"><span class="n">num_tiles_x</span><span class="o">=</span><span class="default_value">50</span></em>, <em class="sig-param"><span class="n">max_tiles_per_slide</span><span class="o">=</span><span class="default_value">100</span></em>, <em class="sig-param"><span class="n">expanded</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">map_slide</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">show_prediction</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">restrict_prediction</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">predict_on_axes</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">whitespace_on_axes</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">outcome_labels</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">cmap</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">model_type</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">umap_cache</span><span class="o">=</span><span class="default_value">'default'</span></em>, <em class="sig-param"><span class="n">activations_cache</span><span class="o">=</span><span class="default_value">'default'</span></em>, <em class="sig-param"><span class="n">activations_export</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">umap_export</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">use_float</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">normalizer</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">normalizer_source</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">low_memory</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">model_format</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="simple">
<dt>Generates a mosaic map by overlaying images onto a set of mapped tiles.</dt><dd><p>Image tiles are extracted from the provided set of TFRecords, and predictions + post-convolutional node activations are calculated using the specified model.
Tiles are mapped either with dimensionality reduction on post-convolutional layer activations (default behavior),
or by using outcome predictions for two categories, mapped to X- and Y-axis (via predict_on_axes).</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> – Path to .h5 file to use when generating layer activations.</p></li>
<li><p><strong>mosaic_filename</strong> – Filename for mosaic image. If not provided, mosaic will not be calculated or saved. Will be saved in project mosaic directory.</p></li>
<li><p><strong>umap_filename</strong> – Filename for UMAP plot image. If not provided, plot will not be saved. Will be saved in project stats directory.</p></li>
<li><p><strong>outcome_header</strong> – Column name in annotations file from which to read category labels.</p></li>
<li><p><strong>filters</strong> – Dataset filters to use when selecting slides to include the mosaic.</p></li>
<li><p><strong>filter_blank</strong> – List of outcome headers; slides that have blank entries in this outcome header
in the annotations file will be excluded</p></li>
<li><p><strong>focus_filters</strong> – Dataset filters to use when selecting slides to highlight on the mosaic.</p></li>
<li><p><strong>resolution</strong> – Resolution of the mosaic map. Impacts size of the final figure. Either low, medium, or high.</p></li>
<li><p><strong>num_tiles_x</strong> – Specifies the size of the mosaic map grid.</p></li>
<li><p><strong>max_tiles_per_slide</strong> – Limits the number of tiles taken from each slide. Too high of a number may introduce memory issues.</p></li>
<li><p><strong>expanded</strong> – Bool. If False, will limit tile assignment to the corresponding grid space (strict display).
If True, allows for display of nearby tiles if a given grid is empty.</p></li>
<li><p><strong>map_slide</strong> – None (default), ‘centroid’, or ‘average’. If provided, will map slides using slide-level calculations, either mapping centroid tiles if ‘centroid’,
or calculating node averages across all tiles in a slide and mapping slide-level node averages, if ‘average’</p></li>
<li><p><strong>show_prediction</strong> – May be either int or string, corresponding to outcome category. Predictions for this category will be displayed
On the exported UMAP plot.</p></li>
<li><p><strong>restrict_prediction</strong> – List of int, if provided, will restrict predictions to only these categories
(final tile-level prediction is made by choosing category with highest logit)</p></li>
<li><p><strong>predict_on_axes</strong> – (int, int). Each int corresponds to an outcome category id.
If provided, predictions are generated for these two outcomes;
tiles are then mapped with these predictions with the pattern (x, y)
and the mosaic is generated from this map. This replaces the default
dimensionality reduction mapping.</p></li>
<li><p><strong>outcome_labels</strong> – Dict mapping outcome id (int) to string labels</p></li>
<li><p><strong>cmap</strong> – Colormap mapping outcomes to colors for display on UMAP plot</p></li>
<li><p><strong>model_type</strong> – Either ‘categorical’ or ‘linear’</p></li>
<li><p><strong>umap_cache</strong> – Either ‘default’ or path to PKL file in which to save/cache UMAP coordinates</p></li>
<li><p><strong>activations_cache</strong> – Either ‘default’ or path to PKL file in which to save/cache nodal activations</p></li>
<li><p><strong>activations_export</strong> – Filename for CSV export of activations. Will be saved in project stats directory.</p></li>
<li><p><strong>umap_export</strong> – Filename for CSV export of UMAP coordinates. Will be saved in project stats directory.</p></li>
<li><p><strong>use_float</strong> – Bool, if True, assumes outcome values are float / linear (as opposed to category labels)</p></li>
<li><p><strong>normalizer</strong> – Normalization strategy to use on image tiles</p></li>
<li><p><strong>normalizer_source</strong> – Path to normalizer source image</p></li>
<li><p><strong>low_memory</strong> – Bool, if True, will attempt to limit memory during UMAP calculations at the cost of increased computational complexity</p></li>
<li><p><strong>model_format</strong> – Optional. May supply format of saved Slideflow Keras model if the model was made with a legacy version.
Default value will be slideflow.model.MODEL_FORMAT_CURRENT,
but slideflow.model.MODEL_FORMAT_LEGACY may be supplied.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<img alt="_images/mosaic_example2.jpg" src="_images/mosaic_example2.jpg" />
<p>If you provide a filename to the <code class="docutils literal notranslate"><span class="pre">umap_filename</span></code> argument, a plot of the constituent tiles will also be saved. If you additionally provide an outcome header (as saved in the annotations file) to the argument <code class="docutils literal notranslate"><span class="pre">outcome_header</span></code>, these tiles will be colored according to the slide-level annotation in the provided outcome header column of the annotations file:</p>
<img alt="_images/umap_example.png" src="_images/umap_example.png" />
<p>Instead of mapping all tiles within a slide, you can choose instead to map only centroid tiles by passing <code class="docutils literal notranslate"><span class="pre">map_slide='centroid'</span></code>:</p>
<img alt="_images/umap_example_centroid.png" src="_images/umap_example_centroid.png" />
<p>There are many additional arguments that can be provided to the <code class="docutils literal notranslate"><span class="pre">generate_mosaic()</span></code> function to customize the mosaic and UMAP plots. However, you may choose to further customize these plots by working with the <code class="docutils literal notranslate"><span class="pre">Mosaic</span></code> and <code class="docutils literal notranslate"><span class="pre">TFRecordMap</span></code> objects directly, which are returned from the <code class="docutils literal notranslate"><span class="pre">generate_mosaic()</span></code> function.</p>
<p>For example, it may be interesting to view a UMAP of tiles with an added third dimension, such as the activation value of a particular penultimate layer node. With this kind of plot, one can visualize how the activation of a particular node varies across the UMAP. To make such a plot, use the <code class="docutils literal notranslate"><span class="pre">save_3d_node_plot</span></code> function of the <code class="docutils literal notranslate"><span class="pre">TFRecordMap</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span><span class="p">,</span> <span class="n">mosaic</span><span class="p">,</span> <span class="n">umap</span> <span class="o">=</span> <span class="n">SFP</span><span class="o">.</span><span class="n">generate_mosaic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;/path/to/saved/model.h5&quot;</span><span class="p">,</span>
                                <span class="n">mosaic_filename</span><span class="o">=</span><span class="s2">&quot;/path/to/destination/mosaic.png&quot;</span><span class="p">,</span>
                                <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;evaluation&quot;</span><span class="p">]})</span>
<span class="n">umap</span><span class="o">.</span><span class="n">save_3d_node_plot</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="mi">497</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/3d_umap.png" src="_images/3d_umap.png" />
</div>
<div class="section" id="working-with-activations">
<h2>Working with activations<a class="headerlink" href="#working-with-activations" title="Permalink to this headline">¶</a></h2>
<p>To work more directly with layer activations, use the <a class="reference internal" href="slideflow.html#slideflow.activations.ActivationsVisualizer" title="slideflow.activations.ActivationsVisualizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">slideflow.activations.ActivationsVisualizer</span></code></a> class. Instancing the class supervises the calculation and caching of layer activations, which can then be exported, viewed (as a mosaic map), or analyzed with various statistical methods. <code class="docutils literal notranslate"><span class="pre">SlideflowProject.generate_activations_analytics()</span></code> automatically creates and returns an instance of this class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span> <span class="o">=</span> <span class="n">SFP</span><span class="o">.</span><span class="n">generate_activations_analytics</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;/path/to/trained_model.h5&#39;</span><span class="p">,</span>
                                        <span class="n">outcome_header</span><span class="o">=</span><span class="s2">&quot;HPV&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_predictions()</span></code> function will return a dictionary mapping slide names to outcome categories and list tile-level predictions. Predictions are ordered according to their position in their corresponding TFRecord. Corresponding tile images can be pulled from the TFRecords with <a class="reference internal" href="slideflow.html#slideflow.io.tfrecords.get_tfrecord_by_index" title="slideflow.io.tfrecords.get_tfrecord_by_index"><code class="xref py py-meth docutils literal notranslate"><span class="pre">slideflow.io.tfrecords.get_tfrecord_by_index()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">()</span>
</pre></div>
</div>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">get_activations()</span></code> function will return a dictionary mapping slide names to layer nodes, listing tile-level activations for each node.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span><span class="o">.</span><span class="n">get_activations</span><span class="p">()</span>
</pre></div>
</div>
<p>To compare activations of layer nodes across outcome categories and find nodes which differ significantly across categories, use the <code class="docutils literal notranslate"><span class="pre">generate_box_plots()</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span><span class="o">.</span><span class="n">generate_box_plots</span><span class="p">()</span>
</pre></div>
</div>
<img alt="_images/boxplot_example.png" src="_images/boxplot_example.png" />
<p>To get a list of the layer nodes which differ most significantly across outcome categories (by ANOVA), use <code class="docutils literal notranslate"><span class="pre">get_top_nodes_by_slide()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">AV</span><span class="o">.</span><span class="n">get_top_nodes_by_slide</span><span class="p">()</span>
</pre></div>
</div>
<p>Many other functions are available, as described in the documentation, <a class="reference internal" href="slideflow.html#slideflow.activations.ActivationsVisualizer" title="slideflow.activations.ActivationsVisualizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">slideflow.activations.ActivationsVisualizer</span></code></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="appendix.html" class="btn btn-neutral float-right" title="Appendix" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="evaluation.html" class="btn btn-neutral float-left" title="Evaluation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, James M Dolezal

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>