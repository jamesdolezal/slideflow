

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slideflow &mdash; slideflow 1.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../root.html" class="icon icon-home"> slideflow
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../root.html">slideflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../root.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>slideflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for slideflow</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">comet_ml</span> <span class="k">import</span> <span class="n">Experiment</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">ascii_lowercase</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="kn">import</span> <span class="nn">slideflow.trainer.model</span> <span class="k">as</span> <span class="nn">sfmodel</span>
<span class="kn">import</span> <span class="nn">slideflow.util</span> <span class="k">as</span> <span class="nn">sfutil</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="k">import</span> <span class="n">TCGA</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">slideflow.util.datasets</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">slideflow.mosaic</span> <span class="k">import</span> <span class="n">Mosaic</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.3.0&quot;</span>

<span class="n">SKIP_VERIFICATION</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">NUM_THREADS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">EVAL_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">GPU_LOCK</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">NO_LABEL</span> <span class="o">=</span> <span class="s1">&#39;no_label&#39;</span>
<span class="n">SILENT</span> <span class="o">=</span> <span class="s1">&#39;SILENT&#39;</span>
<span class="n">SOURCE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">VALIDATION_ID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">COMET_API_KEY</span> <span class="o">=</span> <span class="s2">&quot;A3VWRcPaHgqc4H5K0FoCtRXbp&quot;</span>
<span class="n">DEBUGGING</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="set_logging_level"><a class="viewcode-back" href="../slideflow.html#slideflow.set_logging_level">[docs]</a><span class="k">def</span> <span class="nf">set_logging_level</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">SILENT</span><span class="p">:</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">LOGGING_LEVEL</span><span class="o">.</span><span class="n">SILENT</span> <span class="o">=</span> <span class="kc">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">LOGGING_LEVEL</span><span class="o">.</span><span class="n">INFO</span> <span class="o">=</span> <span class="n">level</span></div>

<div class="viewcode-block" id="autoselect_gpu"><a class="viewcode-back" href="../slideflow.html#slideflow.autoselect_gpu">[docs]</a><span class="k">def</span> <span class="nf">autoselect_gpu</span><span class="p">(</span><span class="n">number_available</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">GPU_LOCK</span>
	<span class="sd">&#39;&#39;&#39;Automatically claims a free GPU and creates a lock file to prevent </span>
<span class="sd">	other instances of slideflow from using the same GPU.&#39;&#39;&#39;</span>
	<span class="n">gpus</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_available</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span> <span class="k">else</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number_available</span><span class="p">))</span>
	<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE_DIR</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;gpu</span><span class="si">{n}</span><span class="s2">.lock&quot;</span><span class="p">)):</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Requesting GPU #</span><span class="si">{n}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
			<span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE_DIR</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;gpu</span><span class="si">{n}</span><span class="s2">.lock&quot;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="n">GPU_LOCK</span> <span class="o">=</span> <span class="n">n</span>
			<span class="k">return</span>
	<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No free GPUs detected; try deleting &#39;gpu[#].lock&#39; files in the slideflow directory if GPUs are not in use.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="select_gpu"><a class="viewcode-back" href="../slideflow.html#slideflow.select_gpu">[docs]</a><span class="k">def</span> <span class="nf">select_gpu</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">GPU_LOCK</span>
	<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Requesting GPU #</span><span class="si">{number}</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="n">GPU_LOCK</span> <span class="o">=</span> <span class="n">number</span>
	<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span></div>

<div class="viewcode-block" id="release_gpu"><a class="viewcode-back" href="../slideflow.html#slideflow.release_gpu">[docs]</a><span class="k">def</span> <span class="nf">release_gpu</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">GPU_LOCK</span>
	<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="s2">&quot;Cleaning up...&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">GPU_LOCK</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE_DIR</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;gpu</span><span class="si">{GPU_LOCK}</span><span class="s2">.lock&quot;</span><span class="p">)):</span>
		<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Freeing GPU </span><span class="si">{GPU_LOCK}</span><span class="s2">...&quot;</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE_DIR</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;gpu</span><span class="si">{GPU_LOCK}</span><span class="s2">.lock&quot;</span><span class="p">))</span></div>
	
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">release_gpu</span><span class="p">)</span>

<div class="viewcode-block" id="SlideflowProject"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject">[docs]</a><span class="k">class</span> <span class="nc">SlideflowProject</span><span class="p">:</span>
	<span class="n">MANIFEST</span> <span class="o">=</span> <span class="kc">None</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_folder</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Initializes project by creating project folder, prompting user for project settings, and project</span>
<span class="sd">		settings to &quot;settings.json&quot; within the project directory.&#39;&#39;&#39;</span>
		<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Slideflow v</span><span class="si">{__version__}</span><span class="se">\n</span><span class="s2">================&quot;</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Loading project...&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">project_folder</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_folder</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">yes_no_input</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Directory &quot;</span><span class="si">{project_folder}</span><span class="s1">&quot; does not exist. Create directory and set as project root? [Y/n] &#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">):</span>
					<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">project_folder</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where is the project root directory? &quot;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Project directory </span><span class="si">{project_folder}</span><span class="s2"> not found; will create.&quot;</span><span class="p">)</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">project_folder</span><span class="p">:</span>
			<span class="n">project_folder</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where is the project root directory? &quot;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">PROJECT_DIR</span> <span class="o">=</span> <span class="n">project_folder</span>

		<span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">project_folder</span><span class="p">,</span> <span class="s2">&quot;settings.json&quot;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">project_folder</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">interactive</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_project</span><span class="p">()</span>
		
<div class="viewcode-block" id="SlideflowProject.extract_tiles"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.extract_tiles">[docs]</a>	<span class="k">def</span> <span class="nf">extract_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_um</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile_px</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_validation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Extract tiles from a group of slides; save a percentage of tiles for validation testing if the </span>
<span class="sd">		validation target is &#39;per-patient&#39;; and generate TFRecord files from the raw images.&#39;&#39;&#39;</span>
		<span class="kn">import</span> <span class="nn">slideflow.convoluter</span> <span class="k">as</span> <span class="nn">convoluter</span>

		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Extracting image tiles...&quot;</span><span class="p">)</span>
		<span class="n">tile_um</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tile_um</span> <span class="k">else</span> <span class="n">tile_um</span>
		<span class="n">tile_px</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tile_px</span> <span class="k">else</span> <span class="n">tile_px</span>
		<span class="n">convoluter</span><span class="o">.</span><span class="n">NUM_THREADS</span> <span class="o">=</span> <span class="n">NUM_THREADS</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="n">extracting_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>

		<span class="k">for</span> <span class="n">dataset_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Working on dataset {sfutil.bold(dataset_name)}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">unfiltered_slide_list</span> <span class="o">=</span> <span class="n">extracting_dataset</span><span class="o">.</span><span class="n">get_slides_by_dataset</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
			<span class="n">slide_list</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">filter_slide_paths</span><span class="p">(</span><span class="n">unfiltered_slide_list</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Extracting tiles from {len(slide_list)} slides (</span><span class="si">{tile_um}</span><span class="s2"> um, </span><span class="si">{tile_px}</span><span class="s2"> px)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			
			<span class="n">save_folder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">extracting_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][</span><span class="s1">&#39;tiles&#39;</span><span class="p">],</span> <span class="n">extracting_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
			<span class="n">roi_dir</span> <span class="o">=</span> <span class="n">extracting_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_folder</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">)</span>

			<span class="n">c</span> <span class="o">=</span> <span class="n">convoluter</span><span class="o">.</span><span class="n">Convoluter</span><span class="p">(</span><span class="n">tile_px</span><span class="p">,</span> <span class="n">tile_um</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
														<span class="n">use_fp16</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;use_fp16&#39;</span><span class="p">],</span> 
														<span class="n">stride_div</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
														<span class="n">save_folder</span><span class="o">=</span><span class="n">save_folder</span><span class="p">,</span> 
														<span class="n">roi_dir</span><span class="o">=</span><span class="n">roi_dir</span><span class="p">)</span>
			<span class="n">c</span><span class="o">.</span><span class="n">load_slides</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
			<span class="n">c</span><span class="o">.</span><span class="n">convolute_slides</span><span class="p">(</span><span class="n">export_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">skip_validation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;per-tile&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;per-tile&#39;</span><span class="p">:</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;boostrap&#39;</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Validation bootstrapping is not supported when the validation target is per-tile; will generate random fixed validation target&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">):</span>
						<span class="c1"># Split the extracted tiles into two groups</span>
						<span class="n">sfutil</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">split_tiles</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">])</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k-fold&#39;</span><span class="p">:</span>
						<span class="n">sfutil</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">split_tiles</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;kfold-</span><span class="si">{i}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">])])</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">generate_tfrecord</span><span class="p">()</span></div>

<div class="viewcode-block" id="SlideflowProject.generate_tfrecord"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.generate_tfrecord">[docs]</a>	<span class="k">def</span> <span class="nf">generate_tfrecord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Create tfrecord files from a collection of raw images&#39;&#39;&#39;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Writing TFRecord files...&#39;</span><span class="p">)</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="n">working_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>
		
		<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">working_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Working on dataset </span><span class="si">{d}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">working_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
			<span class="n">tfrecord_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tfrecords&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
			<span class="n">tiles_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tiles&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>

			<span class="c1"># Check to see if subdirectories in the target folders are slide directories (contain images)</span>
			<span class="c1">#  or are further subdirectories (e.g. validation and training)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scanning tile directory structure...&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">contains_nested_subdirs</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">):</span>
				<span class="n">subdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_dir</span> <span class="k">for</span> <span class="n">_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">_dir</span><span class="p">))]</span>
				<span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">subdirs</span><span class="p">:</span>
					<span class="n">tfrecord_subdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">tfrecord_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>
					<span class="n">sfutil</span><span class="o">.</span><span class="n">tfrecords</span><span class="o">.</span><span class="n">write_tfrecords_multi</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span> <span class="n">tfrecord_subdir</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">sfutil</span><span class="o">.</span><span class="n">tfrecords</span><span class="o">.</span><span class="n">write_tfrecords_multi</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">,</span> <span class="n">tfrecord_dir</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;delete_tiles&#39;</span><span class="p">]:</span>
				<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tiles_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.update_tfrecords"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.update_tfrecords">[docs]</a>	<span class="k">def</span> <span class="nf">update_tfrecords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Updating TFRecords...&#39;</span><span class="p">)</span>
		<span class="n">working_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>

		<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">working_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
			<span class="n">config</span> <span class="o">=</span> <span class="n">working_dataset</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
			<span class="n">tfrecord_folder</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;tfrecords&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>
			<span class="n">num_updated</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Updating TFRecords in {sfutil.green(tfrecord_folder)}...&quot;</span><span class="p">)</span>
			<span class="n">num_updated</span> <span class="o">+=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">tfrecords</span><span class="o">.</span><span class="n">update_tfrecord_dir</span><span class="p">(</span><span class="n">tfrecord_folder</span><span class="p">,</span> <span class="n">slide</span><span class="o">=</span><span class="s1">&#39;case&#39;</span><span class="p">,</span> <span class="n">image_raw</span><span class="o">=</span><span class="s1">&#39;image_raw&#39;</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Updated {sfutil.bold(num_updated)} TFRecords files&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.initialize_model"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.initialize_model">[docs]</a>	<span class="k">def</span> <span class="nf">initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">train_tfrecords</span><span class="p">,</span> <span class="n">validation_tfrecords</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Prepares a Slideflow model using the provided outcome variable (outcome_header) </span>
<span class="sd">		and a given set of training and validation tfrecords.&#39;&#39;&#39;</span>

		<span class="c1"># Using the project annotation file, assemble list of slides for training, as well as the slide annotations dictionary (output labels)</span>
		<span class="n">model_dir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">],</span> <span class="n">model_name</span><span class="p">)</span>

		<span class="c1"># Build a model using the slide list as input and the annotations dictionary as output labels</span>
		<span class="n">SFM</span> <span class="o">=</span> <span class="n">sfmodel</span><span class="o">.</span><span class="n">SlideflowModel</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">train_tfrecords</span><span class="p">,</span> <span class="n">validation_tfrecords</span><span class="p">,</span>
																				<span class="n">manifest</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_manifest</span><span class="p">(),</span>
																				<span class="n">use_fp16</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;use_fp16&#39;</span><span class="p">],</span>
																				<span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SFM</span></div>

<div class="viewcode-block" id="SlideflowProject.evaluate"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.evaluate">[docs]</a>	<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">outcome_header</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span> <span class="n">model_file</span><span class="o">=</span><span class="s2">&quot;trained_model.h5&quot;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_k_fold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Evaluates a saved model on a given set of tfrecords.&#39;&#39;&#39;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Evaluating model {sfutil.bold(model_name)}...&quot;</span><span class="p">)</span>
		<span class="n">model_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">],</span> <span class="n">model_name</span><span class="p">)</span>
		<span class="n">model_fullpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>

		<span class="c1"># Load hyperparameters from saved model</span>
		<span class="n">hp_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model_root</span><span class="p">,</span> <span class="s1">&#39;hyperparameters.json&#39;</span><span class="p">)</span>
		<span class="n">hp_data</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">hp_file</span><span class="p">)</span>
		<span class="n">hp</span> <span class="o">=</span> <span class="n">sfmodel</span><span class="o">.</span><span class="n">HyperParameters</span><span class="p">()</span>
		<span class="n">hp</span><span class="o">.</span><span class="n">_load_dict</span><span class="p">(</span><span class="n">hp_data</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
		
		<span class="c1"># Filter out slides that are blank in the outcome category</span>
		<span class="n">filter_blank</span> <span class="o">=</span> <span class="p">[</span><span class="n">outcome_header</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">outcome_header</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">outcome_header</span>

		<span class="c1"># Load annotations / outcomes</span>
		<span class="n">outcomes</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">get_outcomes_from_annotations</span><span class="p">(</span><span class="n">outcome_header</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">filter_blank</span><span class="o">=</span><span class="n">filter_blank</span><span class="p">,</span> <span class="n">use_float</span><span class="o">=</span><span class="p">(</span><span class="n">model_type</span><span class="o">==</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>
		<span class="c1"># If using a specific k-fold, load validation plan</span>
		<span class="k">if</span> <span class="n">eval_k_fold</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Using {sfutil.bold(&#39;k-fold iteration &#39; + str(eval_k_fold))}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">validation_log</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s2">&quot;validation_plans.json&quot;</span><span class="p">)</span>
			<span class="n">_</span><span class="p">,</span> <span class="n">eval_tfrecords</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">tfrecords</span><span class="o">.</span><span class="n">get_training_and_validation_tfrecords</span><span class="p">(</span><span class="n">eval_dataset</span><span class="p">,</span> <span class="n">validation_log</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span>
																										<span class="n">validation_target</span><span class="o">=</span><span class="n">hp_data</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">],</span>
																										<span class="n">validation_strategy</span><span class="o">=</span><span class="n">hp_data</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">],</span>
																										<span class="n">validation_fraction</span><span class="o">=</span><span class="n">hp_data</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">],</span>
																										<span class="n">validation_k_fold</span><span class="o">=</span><span class="n">hp_data</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">],</span>
																										<span class="n">k_fold_iter</span><span class="o">=</span><span class="n">eval_k_fold</span><span class="p">)</span>
		<span class="c1"># Otherwise use all TFRecords</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">eval_tfrecords</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">get_tfrecords</span><span class="p">(</span><span class="n">ask_to_merge_subdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

		<span class="c1"># Set up model for evaluation</span>
		<span class="n">SFM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;eval-</span><span class="si">{model_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Evaluating {sfutil.bold(len(eval_tfrecords))} tfrecords&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">results</span> <span class="o">=</span> <span class="n">SFM</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">tfrecords</span><span class="o">=</span><span class="n">eval_tfrecords</span><span class="p">,</span> <span class="n">hp</span><span class="o">=</span><span class="n">hp</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_fullpath</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">EVAL_BATCH_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">results</span></div>

	<span class="k">def</span> <span class="nf">_get_hp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Internal function used to convert a row in the batch_train CSV file into a HyperParameters object.&#39;&#39;&#39;</span>
		<span class="n">model_name_i</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
		<span class="n">args</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">model_name_i</span><span class="p">]</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="n">model_name_i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
		<span class="n">model_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">model_name_i</span><span class="p">]</span>
		<span class="n">hp</span> <span class="o">=</span> <span class="n">sfmodel</span><span class="o">.</span><span class="n">HyperParameters</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">arg</span><span class="p">)]</span>
			<span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">hp</span><span class="o">.</span><span class="n">_get_args</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s1">&#39;finetune_epochs&#39;</span><span class="p">:</span>
					<span class="n">arg_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
					<span class="k">if</span> <span class="n">arg_type</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]:</span>
							<span class="n">bool_val</span> <span class="o">=</span> <span class="kc">True</span>
						<span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">]:</span>
							<span class="n">bool_val</span> <span class="o">=</span> <span class="kc">False</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Unable to parse arg &quot;</span><span class="si">{arg}</span><span class="s1">&quot; with value &quot;</span><span class="si">{value}</span><span class="s1">&quot; in batch training file into true/false; will default to True&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
							<span class="n">bool_val</span> <span class="o">=</span> <span class="kc">True</span>
						<span class="nb">setattr</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">bool_val</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="nb">setattr</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">arg_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
					<span class="nb">setattr</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unknown argument &#39;</span><span class="si">{arg}</span><span class="s2">&#39; found in training config file.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hp</span><span class="p">,</span> <span class="n">model_name</span>

	<span class="k">def</span> <span class="nf">_get_valid_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_train_file</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Internal function used to scan a batch_train file for valid, trainable models.&#39;&#39;&#39;</span>
		<span class="n">models_to_train</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">batch_train_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
			<span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">model_name_i</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to find column &#39;model_name&#39; in the batch training config file.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span> 
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
				<span class="n">model_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">model_name_i</span><span class="p">]</span>
				<span class="c1"># First check if this row is a valid model</span>
				<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">models</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span> <span class="ow">and</span> <span class="n">model_name</span><span class="o">==</span><span class="n">models</span><span class="p">)</span> <span class="ow">or</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
					<span class="c1"># Now verify there are no duplicate model names</span>
					<span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models_to_train</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Duplicate model names found in {sfutil.green(batch_train_file)}.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
					<span class="n">models_to_train</span> <span class="o">+=</span> <span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">models_to_train</span>

	<span class="k">def</span> <span class="nf">_update_results_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_log_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">results_dict</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Internal function used to dynamically update results_log when recording training metrics.&#39;&#39;&#39;</span>
		<span class="c1"># First, read current results log into a dictionary</span>
		<span class="n">results_log</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">):</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">results_file</span><span class="p">:</span>
				<span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">results_file</span><span class="p">)</span>
				<span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
				<span class="n">model_name_i</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
				<span class="n">result_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">headers</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;model_name&#39;</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
					<span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">model_name_i</span><span class="p">]</span>
					<span class="n">results_log</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="k">for</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">result_keys</span><span class="p">:</span>
						<span class="n">result</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">result_key</span><span class="p">)]</span>
						<span class="n">results_log</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">result_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
			<span class="c1"># Move the current log file into a temporary file</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{results_log_path}</span><span class="s2">.temp&quot;</span><span class="p">)</span>

		<span class="c1"># Next, update the results log with the new results data</span>
		<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
			<span class="n">results_log</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{model_name}</span><span class="s1">-</span><span class="si">{epoch}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">epoch</span><span class="p">]})</span>

		<span class="c1"># Finally, create a new log file incorporating the new data</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">results_file</span><span class="p">:</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">results_file</span><span class="p">)</span>
			<span class="n">result_keys</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="c1"># Search through results to find all results keys</span>
			<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">:</span>
				<span class="n">result_keys</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="c1"># Remove duplicate result keys</span>
			<span class="n">result_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">result_keys</span><span class="p">))</span>
			<span class="c1"># Write header labels</span>
			<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">result_keys</span><span class="p">)</span>
			<span class="c1"># Iterate through model results and record</span>
			<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">:</span>
				<span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>
				<span class="c1"># Include all saved metrics</span>
				<span class="k">for</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">result_keys</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">result_key</span> <span class="ow">in</span> <span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">]:</span>
						<span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">results_log</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">result_key</span><span class="p">]]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
				<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

		<span class="c1"># Delete the old results log file</span>
		<span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{results_log_path}</span><span class="s2">.temp&quot;</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{results_log_path}</span><span class="s2">.temp&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SlideflowProject.train"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.train">[docs]</a>	<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outcome_header</span><span class="o">=</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">multi_outcome</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume_training</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
				<span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="s1">&#39;imagenet&#39;</span><span class="p">,</span> <span class="n">supervised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;categorical&#39;</span><span class="p">,</span>
				<span class="n">validation_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_k_fold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_fold_iter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Train model(s) given configurations found in batch_train.tsv.</span>

<span class="sd">		Args:</span>
<span class="sd">			models				(optional): Either string representing a model name or an array of strings containing model names. </span>
<span class="sd">									Will train models with these names in the batch_train.tsv config file.</span>
<span class="sd">									Defaults to None, which will train all models in the batch_train.tsv config file.</span>
<span class="sd">			outcome_header		(optional): String or list. Specifies which header(s) in the annotation file to use for the output category. </span>
<span class="sd">									Defaults to &#39;category&#39;.	If a list is provided, will loop through all outcomes and perform HP sweep on each.</span>
<span class="sd">			multi_outcome		(optional): If True, will train to multiple outcomes simultaneously instead of looping through the</span>
<span class="sd">									list of outcomes in &quot;outcome_header&quot;. Defaults to False.</span>
<span class="sd">			filters				(optional): Dictionary of column names mapping to column values by which to filter slides using the annotation file.</span>
<span class="sd">			resume_training		(optional): Path to .h5 model to continue training</span>
<span class="sd">			checkpoint			(optional): Path to cp.ckpt from which to load weights</span>
<span class="sd">			supervised			(optional): Whether to use verbose output and save training progress to Tensorboard</span>
<span class="sd">			batch_file			(optional): Manually specify batch file to use for a hyperparameter sweep. If not specified, will use project default.</span>
<span class="sd">			model_type			(optional): Type of output variable, either categorical (default) or linear.</span>
<span class="sd">			validation_target 	(optional): Whether to select validation data on a &#39;per-patient&#39; or &#39;per-tile&#39; basis. If not specified, will use project default.</span>
<span class="sd">			validation_strategy	(optional): Validation dataset selection strategy (bootstrap, k-fold, fixed, none). If not specified, will use project default.</span>
<span class="sd">			validation_fraction	(optional): Fraction of data to use for validation testing. If not specified, will use project default.</span>
<span class="sd">			validation_k_fold 	(optional): K, if using k-fold validation. If not specified, will use project default.</span>
<span class="sd">			k_fold_iter			(optional): Which iteration to train if using k-fold validation. Defaults to training all iterations.</span>

<span class="sd">		Returns:</span>
<span class="sd">			A dictionary containing model names mapped to train_acc, val_loss, and val_acc</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="c1"># Get list of slides for training and establish validation plan</span>
		<span class="n">batch_train_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_file</span> <span class="k">else</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">global_path</span><span class="p">(</span><span class="n">batch_file</span><span class="p">)</span>
		<span class="n">validation_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_target</span> <span class="k">else</span> <span class="n">validation_target</span>
		<span class="n">validation_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_strategy</span> <span class="k">else</span> <span class="n">validation_strategy</span>
		<span class="n">validation_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_fraction</span> <span class="k">else</span> <span class="n">validation_fraction</span>
		<span class="n">validation_k_fold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_k_fold</span> <span class="k">else</span> <span class="n">validation_k_fold</span>
		<span class="n">validation_log</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s2">&quot;validation_plans.json&quot;</span><span class="p">)</span>
		<span class="n">results_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s2">&quot;results_log.csv&quot;</span><span class="p">)</span>
		<span class="n">k_fold_iter</span> <span class="o">=</span> <span class="p">[</span><span class="n">k_fold_iter</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">k_fold_iter</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">k_fold_iter</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">k_fold_iter</span>
		<span class="n">k_fold</span> <span class="o">=</span> <span class="n">validation_k_fold</span> <span class="k">if</span> <span class="n">validation_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
		<span class="n">valid_k</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k_fold</span> <span class="k">else</span> <span class="p">[</span><span class="n">kf</span> <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_fold</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="n">k_fold_iter</span> <span class="ow">and</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">k_fold_iter</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">k_fold_iter</span><span class="p">))]</span>
		<span class="n">outcome_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">outcome_header</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">outcome_header</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">outcome_header</span>

		<span class="k">if</span> <span class="n">multi_outcome</span> <span class="ow">and</span> <span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple outcome variables only supported for linear outcome variables.&quot;</span><span class="p">)</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

		<span class="c1"># Load dataset for training</span>
		<span class="n">training_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>

		<span class="c1"># Quickly scan for errors (duplicate model names in batch training file) and prepare models to train</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Performing hyperparameter sweep...&quot;</span><span class="p">)</span>
		<span class="n">hp_models_to_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_models</span><span class="p">(</span><span class="n">batch_train_file</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">multi_outcome</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training ({len(hp_models_to_train)} models) using {len(outcome_header)} variables as simultaneous input:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training ({len(hp_models_to_train)} models) for each of {len(outcome_header)} outcome variables:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">outcome_header</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">()</span>

		<span class="c1"># Next, prepare the multiprocessing manager (needed to free VRAM after training and keep track of results)</span>
		<span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
		<span class="n">results_dict</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

		<span class="c1"># Create a worker that can execute one round of training</span>
		<span class="k">def</span> <span class="nf">trainer</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">k_fold_i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">supervised</span><span class="p">:</span>
				<span class="n">k_fold_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k_fold_i</span> <span class="k">else</span> <span class="n">f</span><span class="s2">&quot; (</span><span class="si">{validation_strategy}</span><span class="s2"> iteration #</span><span class="si">{k_fold_i}</span><span class="s2">)&quot;</span>
				<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training model {sfutil.bold(model_name)}</span><span class="si">{k_fold_msg}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">full_model_name</span> <span class="o">=</span> <span class="n">model_name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k_fold_i</span> <span class="k">else</span> <span class="n">model_name</span><span class="o">+</span><span class="n">f</span><span class="s2">&quot;-kfold</span><span class="si">{k_fold_i}</span><span class="s2">&quot;</span>

			<span class="c1"># Initialize Comet experiment</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUGGING</span><span class="p">:</span>
				<span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">COMET_API_KEY</span><span class="p">,</span> <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
				<span class="n">experiment</span><span class="o">.</span><span class="n">log_parameters</span><span class="p">(</span><span class="n">hp</span><span class="o">.</span><span class="n">_get_dict</span><span class="p">())</span>
				<span class="n">experiment</span><span class="o">.</span><span class="n">log_other</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">k_fold_i</span><span class="p">:</span>
					<span class="n">experiment</span><span class="o">.</span><span class="n">log_other</span><span class="p">(</span><span class="s1">&#39;k_fold_iter&#39;</span><span class="p">,</span> <span class="n">k_fold_i</span><span class="p">)</span>

			<span class="c1"># Get TFRecords for training and validation</span>
			<span class="n">training_tfrecords</span><span class="p">,</span> <span class="n">validation_tfrecords</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">tfrecords</span><span class="o">.</span><span class="n">get_training_and_validation_tfrecords</span><span class="p">(</span><span class="n">training_dataset</span><span class="p">,</span> <span class="n">validation_log</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span>
																										<span class="n">validation_target</span><span class="o">=</span><span class="n">validation_target</span><span class="p">,</span>
																										<span class="n">validation_strategy</span><span class="o">=</span><span class="n">validation_strategy</span><span class="p">,</span>
																										<span class="n">validation_fraction</span><span class="o">=</span><span class="n">validation_fraction</span><span class="p">,</span>
																										<span class="n">validation_k_fold</span><span class="o">=</span><span class="n">validation_k_fold</span><span class="p">,</span>
																										<span class="n">k_fold_iter</span><span class="o">=</span><span class="n">k_fold_i</span><span class="p">)</span>
			<span class="c1"># Initialize model</span>
			<span class="n">SFM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">(</span><span class="n">full_model_name</span><span class="p">,</span> <span class="n">training_dataset</span><span class="p">,</span> <span class="n">training_tfrecords</span><span class="p">,</span> <span class="n">validation_tfrecords</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">)</span>

			<span class="c1"># Log model settings and hyperparameters</span>
			<span class="n">hp_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">],</span> <span class="n">full_model_name</span><span class="p">,</span> <span class="s1">&#39;hyperparameters.json&#39;</span><span class="p">)</span>
			<span class="n">hp_data</span> <span class="o">=</span> <span class="p">{</span>
				<span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
				<span class="s2">&quot;tile_px&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span>
				<span class="s2">&quot;tile_um&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">],</span>
				<span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="n">model_type</span><span class="p">,</span>
				<span class="s2">&quot;dataset_config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span>
				<span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">],</span>
				<span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">],</span>
				<span class="s2">&quot;validation_target&quot;</span><span class="p">:</span> <span class="n">validation_target</span><span class="p">,</span>
				<span class="s2">&quot;validation_strategy&quot;</span><span class="p">:</span> <span class="n">validation_strategy</span><span class="p">,</span>
				<span class="s2">&quot;validation_fraction&quot;</span><span class="p">:</span> <span class="n">validation_fraction</span><span class="p">,</span>
				<span class="s2">&quot;validation_k_fold&quot;</span><span class="p">:</span> <span class="n">validation_k_fold</span><span class="p">,</span>
				<span class="s2">&quot;k_fold_i&quot;</span><span class="p">:</span> <span class="n">k_fold_i</span><span class="p">,</span>
				<span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="n">filters</span><span class="p">,</span>
				<span class="s2">&quot;hp&quot;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">_get_dict</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="n">sfutil</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">hp_data</span><span class="p">,</span> <span class="n">hp_file</span><span class="p">)</span>

			<span class="c1"># Execute training</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">results</span> <span class="o">=</span> <span class="n">SFM</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">pretrain</span><span class="o">=</span><span class="n">pretrain</span><span class="p">,</span> 
										<span class="n">resume_training</span><span class="o">=</span><span class="n">resume_training</span><span class="p">,</span> 
										<span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
										<span class="n">supervised</span><span class="o">=</span><span class="n">supervised</span><span class="p">)</span>
				<span class="n">results_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">full_model_name</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span>
				<span class="n">logged_epochs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
				
				<span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUGGING</span><span class="p">:</span> <span class="n">experiment</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">f</span><span class="s1">&#39;epoch{max(logged_epochs)}&#39;</span><span class="p">])</span>
				<span class="k">del</span><span class="p">(</span><span class="n">SFM</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ResourceExhaustedError</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training failed for {sfutil.bold(model_name)}, GPU memory exceeded.&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">del</span><span class="p">(</span><span class="n">SFM</span><span class="p">)</span>
				<span class="k">return</span>

		<span class="k">def</span> <span class="nf">train_to_outcome</span><span class="p">(</span><span class="n">selected_outcome_headers</span><span class="p">):</span>
			<span class="n">outcomes</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">get_outcomes_from_annotations</span><span class="p">(</span><span class="n">selected_outcome_headers</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> 
																					  <span class="n">filter_blank</span><span class="o">=</span><span class="n">selected_outcome_headers</span><span class="p">,</span>
																					  <span class="n">use_float</span><span class="o">=</span><span class="p">(</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">))</span>
			<span class="nb">print</span><span class="p">()</span>

			<span class="c1"># Assembling list of models and hyperparameters from batch_train.tsv file</span>
			<span class="n">batch_train_rows</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">batch_train_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
				<span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
				<span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
					<span class="n">batch_train_rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span>
				
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_train_rows</span><span class="p">:</span>
				<span class="c1"># Read hyperparameters</span>
				<span class="n">hp</span><span class="p">,</span> <span class="n">hp_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hp</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">hp_model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp_models_to_train</span><span class="p">:</span> <span class="k">continue</span>

				<span class="c1"># Generate model name</span>
				<span class="n">outcome_string</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selected_outcome_headers</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">selected_outcome_headers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">selected_outcome_headers</span>
				<span class="n">model_name</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{outcome_string}</span><span class="s2">-</span><span class="si">{hp_model_name}</span><span class="s2">&quot;</span>
				<span class="n">model_iterations</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k_fold</span> <span class="k">else</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{model_name}</span><span class="s2">-kfold{k+1}&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_k</span><span class="p">]</span>

				<span class="c1"># Perform training</span>
				<span class="k">if</span> <span class="n">k_fold</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_k</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">DEBUGGING</span><span class="p">:</span>
							<span class="n">trainer</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">trainer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
							<span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
							<span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">DEBUGGING</span><span class="p">:</span>
						<span class="n">trainer</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">hp</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">trainer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">hp</span><span class="p">))</span>
						<span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
						<span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

				<span class="c1"># Record results</span>
				<span class="k">for</span> <span class="n">mi</span> <span class="ow">in</span> <span class="n">model_iterations</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">mi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
						<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training failed for model </span><span class="si">{model_name}</span><span class="s2"> for an unknown reason&quot;</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_update_results_log</span><span class="p">(</span><span class="n">results_log_path</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">mi</span><span class="p">])</span>
				<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Training complete for model </span><span class="si">{model_name}</span><span class="s2">, results saved to {sfutil.green(results_log_path)}&quot;</span><span class="p">)</span>
			
			<span class="c1"># Print summary of all models</span>
			<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="s2">&quot;Training complete; validation accuracies:&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
				<span class="n">last_epoch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;epoch&#39;</span> <span class="ow">in</span> <span class="n">e</span> <span class="p">])</span>
				<span class="n">final_metrics</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;epoch</span><span class="si">{last_epoch}</span><span class="s1">&#39;</span><span class="p">]</span>
				<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot; - {sfutil.green(model)}: Train_Acc={str(final_metrics[&#39;train_acc&#39;])}, &quot;</span> <span class="o">+</span>
					<span class="n">f</span><span class="s2">&quot;Val_loss=</span><span class="si">{final_metrics[&#39;val_loss&#39;]}</span><span class="s2">, Val_Acc=</span><span class="si">{final_metrics[&#39;val_acc&#39;]}</span><span class="s2">&quot;</span> <span class="p">)</span>

		<span class="c1"># If using multiple outcomes, initiate hyperparameter sweep</span>
		<span class="k">if</span> <span class="n">multi_outcome</span><span class="p">:</span>
			<span class="n">train_to_outcome</span><span class="p">(</span><span class="n">outcome_header</span><span class="p">)</span>

		<span class="c1"># If not training to multiple outcome, perform full hyperparameter sweep</span>
		<span class="c1"># for each outcome category specified</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outcome_header</span><span class="p">:</span>
				<span class="n">results_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
				<span class="n">train_to_outcome</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>
		
<div class="viewcode-block" id="SlideflowProject.generate_heatmaps"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.generate_heatmaps">[docs]</a>	<span class="k">def</span> <span class="nf">generate_heatmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Creates predictive heatmap overlays on a set of slides. </span>

<span class="sd">		Args:</span>
<span class="sd">			model_name:		Which model to use for generating predictions</span>
<span class="sd">			filter_header:	Column name for filtering input slides based on the project annotations file. </span>
<span class="sd">			filter_values:	List of values to include when filtering slides according to filter_header.</span>
<span class="sd">			resolution:		Heatmap resolution (determines stride of tile predictions). </span>
<span class="sd">								&quot;low&quot; uses a stride equal to tile width.</span>
<span class="sd">								&quot;medium&quot; uses a stride equal 1/2 tile width.</span>
<span class="sd">								&quot;high&quot; uses a stride equal to 1/4 tile width.</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="kn">import</span> <span class="nn">slideflow.convoluter</span> <span class="k">as</span> <span class="nn">convoluter</span>
		
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Generating heatmaps...&quot;</span><span class="p">)</span>
		<span class="n">resolutions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">stride_div</span> <span class="o">=</span> <span class="n">resolutions</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid resolution &#39;</span><span class="si">{resolution}</span><span class="s2">&#39;: must be either &#39;low&#39;, &#39;medium&#39;, or &#39;high&#39;.&quot;</span><span class="p">)</span>
			<span class="k">return</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="n">heatmaps_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>
		<span class="n">unfiltered_slide_list</span> <span class="o">=</span> <span class="n">heatmaps_dataset</span><span class="o">.</span><span class="n">get_slide_paths</span><span class="p">()</span>
		<span class="n">slide_list</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">filter_slide_paths</span><span class="p">(</span><span class="n">unfiltered_slide_list</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
		<span class="n">roi_list</span> <span class="o">=</span> <span class="n">heatmaps_dataset</span><span class="o">.</span><span class="n">get_rois</span><span class="p">()</span>
		<span class="n">heatmaps_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s1">&#39;heatmaps&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">heatmaps_folder</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">heatmaps_folder</span><span class="p">)</span>
		<span class="n">model_path</span> <span class="o">=</span> <span class="n">model_name</span> <span class="k">if</span> <span class="n">model_name</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span> <span class="k">else</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">],</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;trained_model.h5&#39;</span><span class="p">)</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">convoluter</span><span class="o">.</span><span class="n">Convoluter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
																					<span class="n">use_fp16</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;use_fp16&#39;</span><span class="p">],</span>
																					<span class="n">stride_div</span><span class="o">=</span><span class="n">stride_div</span><span class="p">,</span>
																					<span class="n">save_folder</span><span class="o">=</span><span class="n">heatmaps_folder</span><span class="p">,</span>
																					<span class="n">roi_list</span><span class="o">=</span><span class="n">roi_list</span><span class="p">)</span>
		<span class="n">c</span><span class="o">.</span><span class="n">load_slides</span><span class="p">(</span><span class="n">slide_list</span><span class="p">)</span>
		<span class="n">c</span><span class="o">.</span><span class="n">build_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
		<span class="n">c</span><span class="o">.</span><span class="n">convolute_slides</span><span class="p">(</span><span class="n">save_heatmaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_final_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">export_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.generate_mosaic"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.generate_mosaic">[docs]</a>	<span class="k">def</span> <span class="nf">generate_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">focus_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Generates a mosaic map with dimensionality reduction on penultimate layer weights. Tile data is extracted from the provided</span>
<span class="sd">		set of TFRecords and predictions are calculated using the specified model.&#39;&#39;&#39;</span>
		
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Generating mosaic map...&quot;</span><span class="p">)</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="n">mosaic_dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>
		<span class="n">mosaic_tfrecords</span> <span class="o">=</span> <span class="n">mosaic_dataset</span><span class="o">.</span><span class="n">get_tfrecords</span><span class="p">(</span><span class="n">ask_to_merge_subdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">model_path</span> <span class="o">=</span> <span class="n">model</span> <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span> <span class="k">else</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">],</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;trained_model.h5&#39;</span><span class="p">)</span>

		<span class="n">slide_list</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">filter_tfrecords_paths</span><span class="p">(</span><span class="n">mosaic_tfrecords</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">focus_filters</span><span class="p">:</span>
			<span class="n">focus_list</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">filter_tfrecords_paths</span><span class="p">(</span><span class="n">mosaic_tfrecords</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">focus_filters</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">focus_list</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">mosaic</span> <span class="o">=</span> <span class="n">Mosaic</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
		<span class="n">mosaic</span><span class="o">.</span><span class="n">generate_from_tfrecords</span><span class="p">(</span><span class="n">slide_list</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">],</span> <span class="n">focus</span><span class="o">=</span><span class="n">focus_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.create_blank_train_config"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.create_blank_train_config">[docs]</a>	<span class="k">def</span> <span class="nf">create_blank_train_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Creates a CSV file with the batch training structure.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">]</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_outfile</span><span class="p">:</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_outfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="c1"># Create headers and first row</span>
			<span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span>
			<span class="n">firstrow</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model1&#39;</span><span class="p">]</span>
			<span class="n">default_hp</span> <span class="o">=</span> <span class="n">sfmodel</span><span class="o">.</span><span class="n">HyperParameters</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_hp</span><span class="o">.</span><span class="n">_get_args</span><span class="p">():</span>
				<span class="n">header</span> <span class="o">+=</span> <span class="p">[</span><span class="n">arg</span><span class="p">]</span>
				<span class="n">firstrow</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">default_hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">)]</span>
			<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
			<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">firstrow</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.create_hyperparameter_sweep"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.create_hyperparameter_sweep">[docs]</a>	<span class="k">def</span> <span class="nf">create_hyperparameter_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finetune_epochs</span><span class="p">,</span> <span class="n">toplayer_epochs</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">pooling</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hidden_layers</span><span class="p">,</span>
									<span class="n">optimizer</span><span class="p">,</span> <span class="n">early_stop</span><span class="p">,</span> <span class="n">early_stop_patience</span><span class="p">,</span> <span class="n">balanced_training</span><span class="p">,</span> <span class="n">balanced_validation</span><span class="p">,</span> <span class="n">augment</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Prepares a hyperparameter sweep using the batch train config file.&#39;&#39;&#39;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Preparing hyperparameter sweep...&quot;</span><span class="p">)</span>
		<span class="c1"># Assemble all possible combinations of provided hyperparameters</span>
		<span class="n">pdict</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
		<span class="k">del</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">])</span>
		<span class="k">del</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
		<span class="k">del</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;finetune_epochs&#39;</span><span class="p">])</span>
		<span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="n">args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
				<span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdict</span><span class="p">[</span><span class="n">arg</span><span class="p">]]</span>
		<span class="n">argsv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
		<span class="n">argsv</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
		<span class="n">sweep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">argsv</span><span class="p">))</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">]</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_outfile</span><span class="p">:</span>
			<span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_outfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="c1"># Create headers</span>
			<span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="s1">&#39;finetune_epochs&#39;</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
				<span class="n">header</span> <span class="o">+=</span> <span class="p">[</span><span class="n">arg</span><span class="p">]</span>
			<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
			<span class="c1"># Iterate through sweep</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sweep</span><span class="p">):</span>
				<span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;HPSweep</span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">finetune_epochs</span><span class="p">])]</span>
				<span class="n">full_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">finetune_epochs</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
				<span class="n">hp</span> <span class="o">=</span> <span class="n">sfmodel</span><span class="o">.</span><span class="n">HyperParameters</span><span class="p">(</span><span class="o">*</span><span class="n">full_params</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">arg</span><span class="p">)]</span>
				<span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Wrote {len(sweep)} combinations for sweep to {sfutil.green(filename)}&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.create_blank_annotations_file"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.create_blank_annotations_file">[docs]</a>	<span class="k">def</span> <span class="nf">create_blank_annotations_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Creates an example blank annotations file.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">outfile</span><span class="p">:</span> 
			<span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_outfile</span><span class="p">:</span>
			<span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_outfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
			<span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">TCGA</span><span class="o">.</span><span class="n">patient</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">]</span>
			<span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.associate_slide_names"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.associate_slide_names">[docs]</a>	<span class="k">def</span> <span class="nf">associate_slide_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Experimental function used to automatically associated patient names with slide filenames in the annotations file.&#39;&#39;&#39;</span>
		<span class="c1"># Load dataset</span>
		<span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>

		<span class="n">sfutil</span><span class="o">.</span><span class="n">update_annotations_with_slidenames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">)</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">load_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.update_manifest"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.update_manifest">[docs]</a>	<span class="k">def</span> <span class="nf">update_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Updates manifest file in the TFRecord directory, used to track number of records and verify annotations.</span>
<span class="sd">		</span>
<span class="sd">		Args:</span>
<span class="sd">			force_update:	If True, will re-validate contents of all TFRecords. If False, will only validate</span>
<span class="sd">								contents of TFRecords not yet in the manifest</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="n">tfrecords_folders</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">get_tfrecords_folders</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">tfr_folder</span> <span class="ow">in</span> <span class="n">tfrecords_folders</span><span class="p">:</span>
			<span class="n">sfutil</span><span class="o">.</span><span class="n">update_tfrecord_manifest</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">tfr_folder</span><span class="p">,</span> 
											<span class="n">force_update</span><span class="o">=</span><span class="n">force_update</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.load_project"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.load_project">[docs]</a>	<span class="k">def</span> <span class="nf">load_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Loads a saved and pre-configured project.&#39;&#39;&#39;</span>
		<span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;settings.json&quot;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;settings.json&quot;</span><span class="p">))</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="s2">&quot;Project configuration loaded.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Unable to locate settings.json at location &quot;</span><span class="si">{directory}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

		<span class="c1"># Enable logging</span>
		<span class="n">log</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">global_path</span><span class="p">(</span><span class="s2">&quot;log.log&quot;</span><span class="p">)</span>

		<span class="c1"># Load dataset for evaluation</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span>
			<span class="c1"># Load annotations</span>
			<span class="n">sfutil</span><span class="o">.</span><span class="n">load_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="n">SKIP_VERIFICATION</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Verifying Annotations...&quot;</span><span class="p">)</span>
				<span class="n">sfutil</span><span class="o">.</span><span class="n">verify_annotations_slides</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
				<span class="n">log</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Verifying TFRecord manifest...&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">update_manifest</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No datasets configured.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.load_datasets"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.load_datasets">[docs]</a>	<span class="k">def</span> <span class="nf">load_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">datasets_data</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="n">datasets_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datasets_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="n">datasets_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
			<span class="n">datasets_data</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="n">datasets_names</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">return</span> <span class="n">datasets_data</span><span class="p">,</span> <span class="n">datasets_names</span></div>

<div class="viewcode-block" id="SlideflowProject.add_dataset"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.add_dataset">[docs]</a>	<span class="k">def</span> <span class="nf">add_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">slides</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">tfrecords</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">datasets_data</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
			<span class="n">datasets_data</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">datasets_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
			<span class="s1">&#39;slides&#39;</span><span class="p">:</span> <span class="n">slides</span><span class="p">,</span>
			<span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="n">roi</span><span class="p">,</span>
			<span class="s1">&#39;tiles&#39;</span><span class="p">:</span> <span class="n">tiles</span><span class="p">,</span>
			<span class="s1">&#39;tfrecords&#39;</span><span class="p">:</span> <span class="n">tfrecords</span><span class="p">,</span>
			<span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span>
		<span class="p">}})</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">datasets_data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saved dataset </span><span class="si">{name}</span><span class="s2"> to </span><span class="si">{path}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideflowProject.save_project"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.save_project">[docs]</a>	<span class="k">def</span> <span class="nf">save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Saves current project configuration as &quot;settings.json&quot;.&#39;&#39;&#39;</span>
		<span class="n">sfutil</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="SlideflowProject.create_project"><a class="viewcode-back" href="../slideflow.html#slideflow.SlideflowProject.create_project">[docs]</a>	<span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Prompts user to provide all relevant project configuration and saves configuration to &quot;settings.json&quot;.&#39;&#39;&#39;</span>
		<span class="c1"># General setup and slide configuration</span>
		<span class="n">project</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">PROJECT_DIR</span><span class="p">}</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;What is the project name? &quot;</span><span class="p">)</span>
		
		<span class="c1"># Ask for annotations file location; if one has not been made, offer to create a blank template and then exit</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">yes_no_input</span><span class="p">(</span><span class="s2">&quot;Has an annotations (CSV) file already been created? [y/N] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">yes_no_input</span><span class="p">(</span><span class="s2">&quot;Create a blank annotations file? [Y/n] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">):</span>
				<span class="n">project</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">file_input</span><span class="p">(</span><span class="s2">&quot;Where will the annotation file be located? [./annotations.csv] &quot;</span><span class="p">,</span> 
									<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./annotations.csv&#39;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">create_blank_annotations_file</span><span class="p">(</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">file_input</span><span class="p">(</span><span class="s2">&quot;Where is the project annotations (CSV) file located? [./annotations.csv] &quot;</span><span class="p">,</span> 
									<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./annotations.csv&#39;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span>

		<span class="c1"># Dataset configuration</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">file_input</span><span class="p">(</span><span class="s2">&quot;Where is the dataset configuration file located? [./datasets.json] &quot;</span><span class="p">,</span>
													<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./datasets.json&#39;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">while</span> <span class="ow">not</span> <span class="n">project</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]:</span>
			<span class="n">datasets_data</span><span class="p">,</span> <span class="n">datasets_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">])</span>

			<span class="nb">print</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">bold</span><span class="p">(</span><span class="s2">&quot;Detected datasets:&quot;</span><span class="p">))</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets_names</span><span class="p">):</span>
				<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [None]&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets_names</span><span class="p">):</span>
					<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot; {i+1}. </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot; {len(datasets_names)+1}. ADD NEW&quot;</span><span class="p">)</span>
				<span class="n">dataset_selection</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">choice_input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Which datasets should be used? (choose {len(datasets_names)+1} to add a new dataset) &quot;</span><span class="p">,</span> <span class="n">valid_choices</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets_names</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">))],</span> <span class="n">multi_choice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets_names</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets_names</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dataset_selection</span><span class="p">:</span>
				<span class="c1"># Create new dataset</span>
				<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{sfutil.bold(&#39;Creating new dataset&#39;)}&quot;</span><span class="p">)</span>
				<span class="n">dataset_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;What is the dataset name? &quot;</span><span class="p">)</span>
				<span class="n">dataset_slides</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where are the slides stored? [./slides] &quot;</span><span class="p">,</span>
										<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./slides&#39;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">dataset_roi</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where are the ROI files (CSV) stored? [./slides] &quot;</span><span class="p">,</span>
										<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./slides&#39;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">dataset_tiles</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where will the tessellated image tiles be stored? (recommend SSD) [./tiles] &quot;</span><span class="p">,</span>
										<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./tiles&#39;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">dataset_tfrecords</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where should the TFRecord files be stored? (recommend HDD) [./tfrecord] &quot;</span><span class="p">,</span>
										<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./tfrecord&#39;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

				<span class="bp">self</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;dataset_config&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">dataset_name</span><span class="p">,</span>
																 <span class="n">slides</span><span class="o">=</span><span class="n">dataset_slides</span><span class="p">,</span>
																 <span class="n">roi</span><span class="o">=</span><span class="n">dataset_roi</span><span class="p">,</span>
																 <span class="n">tiles</span><span class="o">=</span><span class="n">dataset_tiles</span><span class="p">,</span>
																 <span class="n">tfrecords</span><span class="o">=</span><span class="n">dataset_tfrecords</span><span class="p">,</span>
																 <span class="n">label</span><span class="o">=</span><span class="n">NO_LABEL</span><span class="p">)</span>

				<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updated dataset configuration file.&quot;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">project</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">datasets_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dataset_selection</span><span class="p">]</span>
				<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
					<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Invalid selection: </span><span class="si">{dataset_selection}</span><span class="s1">&#39;</span><span class="p">)</span>
					<span class="k">continue</span>

		<span class="c1"># Other tessellation</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;delete_tiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">yes_no_input</span><span class="p">(</span><span class="s2">&quot;Should raw tile images be deleted after TFRecord storage? [Y/n] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>

		<span class="c1"># Training</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;models_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">dir_input</span><span class="p">(</span><span class="s2">&quot;Where should the saved models be stored? [./models] &quot;</span><span class="p">,</span>
									<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./models&#39;</span><span class="p">,</span> <span class="n">create_on_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;tile_um&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">int_input</span><span class="p">(</span><span class="s2">&quot;What is the tile width in microns? [280] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">280</span><span class="p">)</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;tile_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">int_input</span><span class="p">(</span><span class="s2">&quot;What is the tile width in pixels? [224] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">224</span><span class="p">)</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;use_fp16&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">yes_no_input</span><span class="p">(</span><span class="s2">&quot;Should FP16 be used instead of FP32? (recommended) [Y/n] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">file_input</span><span class="p">(</span><span class="s2">&quot;Location for the batch training TSV config file? [./batch_train.tsv] &quot;</span><span class="p">,</span>
													<span class="n">default</span><span class="o">=</span><span class="s1">&#39;./batch_train.tsv&#39;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s1">&#39;tsv&#39;</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		
		<span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">]):</span>
			<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch training file not found, creating blank&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">create_blank_train_config</span><span class="p">(</span><span class="n">project</span><span class="p">[</span><span class="s1">&#39;batch_train_config&#39;</span><span class="p">])</span>
		
		<span class="c1"># Validation strategy</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">float_input</span><span class="p">(</span><span class="s2">&quot;What fraction of training data should be used for validation testing? [0.2] &quot;</span><span class="p">,</span> <span class="n">valid_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
		<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">choice_input</span><span class="p">(</span><span class="s2">&quot;How should validation data be selected by default, per-tile or per-patient? [per-patient] &quot;</span><span class="p">,</span> <span class="n">valid_choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per-tile&#39;</span><span class="p">,</span> <span class="s1">&#39;per-patient&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;per-patient&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;per-patient&#39;</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">choice_input</span><span class="p">(</span><span class="s2">&quot;Which validation strategy should be used by default, k-fold, bootstrap, or fixed? [k-fold]&quot;</span><span class="p">,</span> <span class="n">valid_choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;k-fold&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">choice_input</span><span class="p">(</span><span class="s2">&quot;Which validation strategy should be used by default, k-fold or fixed? &quot;</span><span class="p">,</span> <span class="n">valid_choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;k-fold&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k-fold&#39;</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">int_input</span><span class="p">(</span><span class="s2">&quot;What is K? [3] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_strategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">int_input</span><span class="p">(</span><span class="s2">&quot;How many iterations should be performed when bootstrapping? [3] &quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">project</span><span class="p">[</span><span class="s1">&#39;validation_k_fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="n">sfutil</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">PROJECT_DIR</span><span class="p">,</span> <span class="s1">&#39;settings.json&#39;</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">PROJECT</span> <span class="o">=</span> <span class="n">project</span>

		<span class="c1"># Write a sample actions.py file</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE_DIR</span><span class="p">,</span> <span class="s1">&#39;sample_actions.py&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sample_file</span><span class="p">:</span>
			<span class="n">sample_actions</span> <span class="o">=</span> <span class="n">sample_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">PROJECT_DIR</span><span class="p">,</span> <span class="s1">&#39;actions.py&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">actions_file</span><span class="p">:</span>
				<span class="n">actions_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sample_actions</span><span class="p">)</span>

		<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Project configuration saved.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">PROJECT_DIR</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, James M Dolezal

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>