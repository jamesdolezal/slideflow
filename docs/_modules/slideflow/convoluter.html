

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slideflow.convoluter &mdash; slideflow 1.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../root.html" class="icon icon-home"> slideflow
          

          
          </a>

          
            
            
              <div class="version">
                1.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project.html">Setting up a Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../validation.html">Validation Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extract_tiles.html">Tile extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../evaluation.html">Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../root.html">slideflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../root.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../slideflow.html">slideflow</a> &raquo;</li>
        
      <li>slideflow.convoluter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for slideflow.convoluter</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) James Dolezal - All Rights Reserved</span>
<span class="c1"># Unauthorized copying of this file, via any medium is strictly prohibited</span>
<span class="c1"># Proprietary and confidential</span>
<span class="c1"># Written by James Dolezal &lt;jamesmdolezal@gmail.com&gt;, March 2019</span>
<span class="c1"># ==========================================================================</span>

<span class="sd">&#39;&#39;&#39;This module includes tools to convolutionally section whole slide images into tiles</span>
<span class="sd">using python Generators. These tessellated tiles can be exported as JPGs, with or without</span>
<span class="sd">data augmentation, or used as input for a trained Tensorflow model. Model predictions </span>
<span class="sd">can then be visualized as a heatmap overlay.</span>

<span class="sd">This module is compatible with SVS and JPG images.</span>

<span class="sd">Requires: Openslide (https://openslide.org/download/).&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">exists</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">openslide</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sg</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span>

<span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Manager</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Queue</span>

<span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="k">import</span> <span class="n">Slider</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcol</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">mp</span>

<span class="kn">import</span> <span class="nn">slideflow.util</span> <span class="k">as</span> <span class="nn">sfutil</span>
<span class="kn">import</span> <span class="nn">slideflow.util.datasets</span> <span class="k">as</span> <span class="nn">sfdatasets</span>
<span class="kn">from</span> <span class="nn">slideflow.util</span> <span class="k">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">progress_bar</span>
<span class="kn">from</span> <span class="nn">slideflow.util.fastim</span> <span class="k">import</span> <span class="n">FastImshow</span>

<span class="n">Image</span><span class="o">.</span><span class="n">MAX_IMAGE_PIXELS</span> <span class="o">=</span> <span class="mi">100000000000</span>
<span class="n">NUM_THREADS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DEFAULT_JPG_MPP</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">SKIP_MISSING_ROI</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># BatchNormFix</span>
<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">UpdatedBatchNormalization</span>

<span class="c1"># TODO: test JPG compatibility</span>

<div class="viewcode-block" id="ROIObject"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.ROIObject">[docs]</a><span class="k">class</span> <span class="nc">ROIObject</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;Object container for ROI annotations.&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
<div class="viewcode-block" id="ROIObject.add_coord"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.ROIObject.add_coord">[docs]</a>	<span class="k">def</span> <span class="nf">add_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span></div>
<div class="viewcode-block" id="ROIObject.scaled_area"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.ROIObject.scaled_area">[docs]</a>	<span class="k">def</span> <span class="nf">scaled_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span></div>
<div class="viewcode-block" id="ROIObject.print_coord"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.ROIObject.print_coord">[docs]</a>	<span class="k">def</span> <span class="nf">print_coord</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>
<div class="viewcode-block" id="ROIObject.add_shape"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.ROIObject.add_shape">[docs]</a>	<span class="k">def</span> <span class="nf">add_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_coord</span><span class="p">(</span><span class="n">point</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="JPGSlide"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.JPGSlide">[docs]</a><span class="k">class</span> <span class="nc">JPGSlide</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;Object that provides cross-compatibility with certain OpenSlide methods when using JPG slides.&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mpp</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">loaded_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="c1"># ImageIO version</span>
		<span class="c1">#self.loaded_image = imageio.imread(path)</span>
		<span class="c1">#self.dimensions = (self.loaded_image.shape[1], self.loaded_image.shape[0])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">ops</span><span class="o">.</span><span class="n">PROPERTY_NAME_MPP_X</span><span class="p">:</span> <span class="n">mpp</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">level_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">level_count</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">level_downsamples</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>

<div class="viewcode-block" id="JPGSlide.get_thumbnail"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.JPGSlide.get_thumbnail">[docs]</a>	<span class="k">def</span> <span class="nf">get_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
		<span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">resize</span><span class="p">([</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">resample</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span><span class="p">)</span></div>
		<span class="c1"># ImageIO version</span>
		<span class="c1">#return cv2.resize(self.loaded_image, dsize=dimensions, interpolation=cv2.INTER_CUBIC)</span>

<div class="viewcode-block" id="JPGSlide.read_region"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.JPGSlide.read_region">[docs]</a>	<span class="k">def</span> <span class="nf">read_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topleft</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
		<span class="c1"># Arg &quot;level&quot; required for code compatibility with slide reader but is not used</span>
		<span class="c1"># Window = [y, x] pixels (note: this is reverse compared to slide/SVS files in [x,y] format)</span>

		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_image</span><span class="o">.</span><span class="n">crop</span><span class="p">([</span><span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">window</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span></div>

		<span class="c1"># ImageIO version</span>
		<span class="c1">#return self.loaded_image[topleft[1]:topleft[1] + window[1], </span>
		<span class="c1">#						 topleft[0]:topleft[0] + window[0],]</span>

<div class="viewcode-block" id="JPGSlide.get_best_level_for_downsample"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.JPGSlide.get_best_level_for_downsample">[docs]</a>	<span class="k">def</span> <span class="nf">get_best_level_for_downsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">downsample_desired</span><span class="p">):</span>
		<span class="k">return</span> <span class="mi">0</span></div></div>

<div class="viewcode-block" id="SlideReader"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.SlideReader">[docs]</a><span class="k">class</span> <span class="nc">SlideReader</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;Helper object that loads a slide and its ROI annotations and sets up a tile generator.&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">size_px</span><span class="p">,</span> <span class="n">size_um</span><span class="p">,</span> <span class="n">stride_div</span><span class="p">,</span> <span class="n">export_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="nb">print</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pb</span> <span class="k">else</span> <span class="n">pb</span><span class="o">.</span><span class="n">print</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rois</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span> <span class="c1"># Progress bar</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">p_id</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">_shortname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">export_folder</span> <span class="o">=</span> <span class="n">export_folder</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">size_px</span> <span class="o">=</span> <span class="n">size_px</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">export_folder</span> <span class="k">else</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># previously self.shortname</span>

		<span class="c1"># Initiate supported slide (SVS, TIF) or JPG slide reader</span>
		<span class="k">if</span> <span class="n">filetype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">SUPPORTED_FORMATS</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">slide</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">ops</span><span class="o">.</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">OpenSlideUnsupportedFormatError</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot; Unable to read slide from </span><span class="si">{path}</span><span class="s2"> , skipping&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">return</span>
		<span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;jpg&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">slide</span> <span class="o">=</span> <span class="n">JPGSlide</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mpp</span><span class="o">=</span><span class="n">DEFAULT_JPG_MPP</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unsupported file type &#39;</span><span class="si">{filetype}</span><span class="s2">&#39; for slide </span><span class="si">{self.name}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">return</span>

		<span class="c1"># Load ROI from roi_dir if available</span>
		<span class="k">if</span> <span class="n">roi_dir</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)):</span>
			<span class="n">num_rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">))</span>
		<span class="c1"># Else try loading ROI from same folder as slide</span>
		<span class="k">elif</span> <span class="n">exists</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
			<span class="n">num_rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">roi_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roi_list</span><span class="p">]:</span>
			<span class="n">matching_rois</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">roi_list</span><span class="p">):</span>
				<span class="n">rn</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">rn</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
					<span class="n">matching_rois</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rp</span><span class="p">]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_rois</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot; Multiple matching ROIs found for </span><span class="si">{self.name}</span><span class="s2">; using </span><span class="si">{matching_rois[0]}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">num_rois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv_roi</span><span class="p">(</span><span class="n">matching_rois</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">SKIP_MISSING_ROI</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No ROI found for {sfutil.green(self.name)}, skipping slide&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">return</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;[{sfutil.green(self.shortname)}]  No ROI found in </span><span class="si">{roi_dir}</span><span class="s2">, using whole slide.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
				<span class="n">num_rois</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="c1"># Collect basic slide information</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">MPP</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">ops</span><span class="o">.</span><span class="n">PROPERTY_NAME_MPP_X</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size_um</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPP</span><span class="p">)</span>
		<span class="n">log</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Loaded {filetype.upper()}: </span><span class="si">{self.MPP}</span><span class="s2"> um/px | </span><span class="si">{num_rois}</span><span class="s2"> ROI(s) | Size: </span><span class="si">{self.full_shape[0]}</span><span class="s2"> x </span><span class="si">{self.full_shape[1]}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>

		<span class="c1"># Load downsampled level based on desired extraction size</span>
		<span class="n">downsample_desired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="n">size_px</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">get_best_level_for_downsample</span><span class="p">(</span><span class="n">downsample_desired</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_downsamples</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">]</span>
		<span class="n">log</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Using level {sfutil.bold(self.downsample_level)} downsample (factor: {sfutil.bold(f&#39;</span><span class="si">{self.downsample_factor:.1f}</span><span class="s2">&#39;)}) for performance, shape {sfutil.bold(self.shape)}&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>

		<span class="c1"># Calculate filter dimensions (low magnification for filtering out white background)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">filter_dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">filter_magnification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">filter_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_magnification</span><span class="p">)</span>
		
		<span class="c1"># Calculate pixel size of extraction window using downsampling</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_factor</span><span class="p">)</span>
		<span class="n">stride_um</span> <span class="o">=</span> <span class="n">size_um</span> <span class="o">/</span> <span class="n">stride_div</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">/</span> <span class="n">stride_div</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span> <span class="o">/</span> <span class="n">stride_div</span> <span class="c1">#(should be int)</span>
		
		<span class="n">log</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Extracting {sfutil.bold(size_um)}um tiles, stride {sfutil.bold(int(stride_um))}um, resizing {sfutil.bold(self.extract_px)}px -&gt; {sfutil.bold(size_px)}px&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">size_px</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;[{sfutil.fail(&#39;!WARN!&#39;)}] Tiles will be up-scaled with cubic interpolation, (</span><span class="si">{self.extract_px}</span><span class="s2">px -&gt; </span><span class="si">{size_px}</span><span class="s2">px)&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>

		<span class="c1"># Generating thumbnail for heatmap</span>
		<span class="n">thumbs_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;thumbs&quot;</span><span class="p">)</span>
		<span class="n">sfdatasets</span><span class="o">.</span><span class="n">make_dir</span><span class="p">(</span><span class="n">thumbs_path</span><span class="p">)</span>
		<span class="n">goal_thumb_area</span> <span class="o">=</span> <span class="mi">4096</span><span class="o">*</span><span class="mi">4096</span>
		<span class="n">y_x_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">thumb_x</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">goal_thumb_area</span> <span class="o">/</span> <span class="n">y_x_ratio</span><span class="p">)</span>
		<span class="n">thumb_y</span> <span class="o">=</span> <span class="n">thumb_x</span> <span class="o">*</span> <span class="n">y_x_ratio</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">thumb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">get_thumbnail</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">thumb_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">thumb_y</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">thumb_file</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">thumbs_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1">_thumb.jpg&#39;</span><span class="p">)</span>
		<span class="n">imageio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumb_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumb</span><span class="p">)</span>

<div class="viewcode-block" id="SlideReader.loaded_correctly"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.SlideReader.loaded_correctly">[docs]</a>	<span class="k">def</span> <span class="nf">loaded_correctly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_error</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">loaded_correctly</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
		<span class="k">except</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Slide failed to load properly for slide {sfutil.green(self.name)}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
			<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">loaded_correctly</span></div>

<div class="viewcode-block" id="SlideReader.build_generator"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.SlideReader.build_generator">[docs]</a>	<span class="k">def</span> <span class="nf">build_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="c1"># Calculate window sizes, strides, and coordinates for windows</span>
		<span class="n">coord</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">slide_x_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span>
		<span class="n">slide_y_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span>

		<span class="c1"># Coordinates must be in level 0 (full) format for the read_region function</span>
		<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="p">):</span>
				<span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
				<span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
				<span class="n">is_unique</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">is_unique</span><span class="p">])</span>

		<span class="c1"># Load annotations as shapely.geometry objects</span>
		<span class="n">ROI_SCALE</span> <span class="o">=</span> <span class="mi">10</span>
		<span class="n">annPolys</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">scaled_area</span><span class="p">(</span><span class="n">ROI_SCALE</span><span class="p">))</span> <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">]</span>
		<span class="n">roi_area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">poly</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">annPolys</span><span class="p">])</span>
		<span class="n">total_area</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ROI_SCALE</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ROI_SCALE</span><span class="p">)</span>
		<span class="n">roi_area_fraction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">roi_area</span> <span class="k">else</span> <span class="p">(</span><span class="n">roi_area</span> <span class="o">/</span> <span class="n">total_area</span><span class="p">)</span>

		<span class="n">total_logits_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="o">*</span> <span class="n">roi_area_fraction</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">total_logits_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No tiles were able to be extracted at the given micron size for slide {sfutil.green(self.name)}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
		<span class="c1"># Create mask for indicating whether tile was extracted</span>
		<span class="n">tile_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">))])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tile_mask</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">p_id</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_logits_count</span><span class="p">,</span> <span class="n">endtext</span><span class="o">=</span><span class="n">sfutil</span><span class="o">.</span><span class="n">green</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortname</span><span class="p">))</span>

		<span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
			<span class="n">tile_counter</span><span class="o">=</span><span class="mi">0</span>
			<span class="k">if</span> <span class="n">export</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)):</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span>
				<span class="c1"># Check if the center of the current window lies within any annotation; if not, skip</span>
				<span class="n">x_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">ROI_SCALE</span><span class="p">)</span>
				<span class="n">y_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">full_extract_px</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">ROI_SCALE</span><span class="p">)</span>
				<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">annPolys</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">annPoly</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">))</span> <span class="k">for</span> <span class="n">annPoly</span> <span class="ow">in</span> <span class="n">annPolys</span><span class="p">]):</span>
					<span class="k">continue</span>
				<span class="n">tile_counter</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_id</span><span class="p">,</span> <span class="n">tile_counter</span><span class="p">)</span>
				<span class="c1"># Read the low-mag level for filter checking</span>
				<span class="n">filter_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">level_count</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_px</span><span class="p">]))[:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">median_brightness</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">filter_region</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
				<span class="k">if</span> <span class="n">median_brightness</span> <span class="o">&gt;</span> <span class="mi">660</span><span class="p">:</span>
					<span class="c1"># Discard tile; median brightness (average RGB pixel) &gt; 220</span>
					<span class="k">continue</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">update_counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
				<span class="c1"># Read the region and discard the alpha pixels</span>
				<span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slide</span><span class="o">.</span><span class="n">read_region</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_level</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_px</span><span class="p">])</span>
				<span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size_px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_px</span><span class="p">))</span>
				<span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
				<span class="n">tile_mask</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="n">coord_label</span> <span class="o">=</span> <span class="n">ci</span>
				<span class="n">unique_tile</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">export</span> <span class="ow">and</span> <span class="n">unique_tile</span><span class="p">:</span>
					<span class="n">region</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">.jpg&#39;</span><span class="p">),</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_90</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug1.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug2.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_90</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug3.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug4.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_90</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug5.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug6.jpg&#39;</span><span class="p">))</span>
						<span class="n">region</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">ROTATE_90</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_LEFT_RIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">FLIP_TOP_BOTTOM</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tiles_path</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{self.shortname}</span><span class="s1">_</span><span class="si">{ci}</span><span class="s1">_aug7.jpg&#39;</span><span class="p">))</span>
				<span class="k">yield</span> <span class="n">region</span><span class="p">,</span> <span class="n">coord_label</span><span class="p">,</span> <span class="n">unique_tile</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_id</span><span class="p">)</span>
				<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Finished tile extraction for {sfutil.green(self.shortname)} ({sum(tile_mask)} tiles of {len(coord)} possible)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tile_mask</span> <span class="o">=</span> <span class="n">tile_mask</span>

		<span class="k">return</span> <span class="n">generator</span><span class="p">,</span> <span class="n">slide_x_size</span><span class="p">,</span> <span class="n">slide_y_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_stride</span><span class="p">,</span> <span class="n">roi_area_fraction</span></div>

<div class="viewcode-block" id="SlideReader.load_csv_roi"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.SlideReader.load_csv_roi">[docs]</a>	<span class="k">def</span> <span class="nf">load_csv_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="n">roi_dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
			<span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unable to read CSV ROI file {sfutil.green(path)}, please check file integrity and ensure it is not empty.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">index_name</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;ROI_name&quot;</span><span class="p">)</span>
				<span class="n">index_x</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;X_base&quot;</span><span class="p">)</span>
				<span class="n">index_y</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Y_base&quot;</span><span class="p">)</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">index_name</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;ROI_Name&quot;</span><span class="p">)</span>
					<span class="n">index_x</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;X_base&quot;</span><span class="p">)</span>
					<span class="n">index_y</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Y_base&quot;</span><span class="p">)</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Unable to find &quot;ROI_name&quot;, &quot;X_base&quot;, and &quot;Y_base&quot; columns in CSV file.&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
				<span class="n">roi_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>
				<span class="n">x_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_x</span><span class="p">]))</span>
				<span class="n">y_coord</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">index_y</span><span class="p">]))</span>
				
				<span class="k">if</span> <span class="n">roi_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="p">:</span>
					<span class="n">roi_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">roi_name</span><span class="p">:</span> <span class="n">ROIObject</span><span class="p">(</span><span class="n">roi_name</span><span class="p">)})</span>
				<span class="n">roi_dict</span><span class="p">[</span><span class="n">roi_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_coord</span><span class="p">((</span><span class="n">x_coord</span><span class="p">,</span> <span class="n">y_coord</span><span class="p">))</span>

			<span class="k">for</span> <span class="n">roi_object</span> <span class="ow">in</span> <span class="n">roi_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi_object</span><span class="p">)</span>

			<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlideReader.load_json_roi"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.SlideReader.load_json_roi">[docs]</a>	<span class="k">def</span> <span class="nf">load_json_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="n">JSON_ANNOTATION_SCALE</span> <span class="o">=</span> <span class="mi">10</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
			<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)[</span><span class="s1">&#39;shapes&#39;</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
			<span class="n">area_reduced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span> <span class="n">JSON_ANNOTATION_SCALE</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROIObject</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Object{len(self.rois)}&quot;</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span><span class="n">area_reduced</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Convoluter"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter">[docs]</a><span class="k">class</span> <span class="nc">Convoluter</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;Class to guide the convolution/tessellation of tiles across a set of slides, within ROIs if provided. </span>
<span class="sd">	Performs designated actions on tessellated tiles, which may include:</span>
<span class="sd">	</span>
<span class="sd">	 - image export (for generating a tile dataset, with or	without augmentation)</span>
<span class="sd">	 - logit predictions from saved Tensorflow model (logits may then be either saved or visualized with heatmaps)</span>
<span class="sd">	 - final layer weight calculation (saved into a CSV file)</span>
<span class="sd">	&#39;&#39;&#39;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_px</span><span class="p">,</span> <span class="n">size_um</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">use_fp16</span><span class="p">,</span> <span class="n">stride_div</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_folder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">roi_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ROI_DIR</span> <span class="o">=</span> <span class="n">roi_dir</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ROI_LIST</span> <span class="o">=</span> <span class="n">roi_list</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SIZE_PX</span> <span class="o">=</span> <span class="n">size_px</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SIZE_UM</span> <span class="o">=</span> <span class="n">size_um</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="n">batch_size</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DTYPE</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="n">use_fp16</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DTYPE_INT</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int16</span> <span class="k">if</span> <span class="n">use_fp16</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span> <span class="o">=</span> <span class="n">save_folder</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">STRIDE_DIV</span> <span class="o">=</span> <span class="n">stride_div</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">AUGMENT</span> <span class="o">=</span> <span class="n">augment</span>

	<span class="k">def</span> <span class="nf">_parse_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
		<span class="n">parsed_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">per_image_standardization</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
		<span class="n">parsed_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">parsed_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DTYPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parsed_image</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mask</span>

<div class="viewcode-block" id="Convoluter.load_slides"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.load_slides">[docs]</a>	<span class="k">def</span> <span class="nf">load_slides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slides_array</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">slide_path</span> <span class="ow">in</span> <span class="n">slides_array</span><span class="p">:</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_name</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span>
			<span class="n">filetype</span> <span class="o">=</span> <span class="n">sfutil</span><span class="o">.</span><span class="n">path_to_ext</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
										<span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">slide_path</span><span class="p">,</span>
										<span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">filetype</span><span class="p">,</span>
										<span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span> <span class="p">}</span> <span class="p">})</span></div>

<div class="viewcode-block" id="Convoluter.build_model"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.build_model">[docs]</a>	<span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">model_dir</span>

		<span class="c1"># First, load the designated model</span>
		<span class="n">_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_DIR</span><span class="p">)</span>

		<span class="c1"># Now, construct a new model that outputs both predictions and final layer weights</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">_model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="p">],</span>
										   <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">])</span>

		<span class="c1"># Record the number of classes in the model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Convoluter.convolute_slides"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.convolute_slides">[docs]</a>	<span class="k">def</span> <span class="nf">convolute_slides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_heatmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display_heatmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_final_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">export_tiles</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Parent function to guide convolution across a whole-slide image and execute desired functions.</span>

<span class="sd">		Args:</span>
<span class="sd">			save_heatmaps: 				Bool, if true will save heatmap overlays as PNG files</span>
<span class="sd">			display_heatmaps:			Bool, if true will display interactive heatmap for each whole-slide image</span>
<span class="sd">			save_final_layer: 			Bool, if true will calculate and save final layer weights in CSV file</span>
<span class="sd">			export_tiles:				Bool, if true will save tessellated image tiles to subdirectory &quot;tiles&quot;</span>

<span class="sd">		Returns:</span>
<span class="sd">			None</span>
<span class="sd">		&#39;&#39;&#39;</span>
		<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">DecompressionBombWarning</span><span class="p">)</span>

		<span class="c1"># If we are not making heatmaps, there is no need to work with overlapping tiles</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">save_heatmaps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">display_heatmaps</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tessellating only non-overlapping tiles.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">STRIDE_DIV</span> <span class="o">=</span> <span class="mi">1</span>

		<span class="c1"># Check if we are doing image tile extraction only</span>
		<span class="k">if</span> <span class="n">export_tiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">display_heatmaps</span> <span class="ow">or</span> <span class="n">save_final_layer</span> <span class="ow">or</span> <span class="n">save_heatmaps</span><span class="p">):</span>
			<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exporting tiles only.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">pb</span> <span class="o">=</span> <span class="n">progress_bar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">bar_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">counter_text</span><span class="o">=</span><span class="s1">&#39;tiles&#39;</span><span class="p">)</span>
			<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">slide</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">export_tiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span> <span class="n">pb</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">NUM_THREADS</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">NUM_THREADS</span><span class="p">)</span>
				<span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">)</span><span class="c1">#lambda slide: self.export_tiles(self.SLIDES[slide], pb), self.SLIDES)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">export_tiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">[</span><span class="n">slide</span><span class="p">],</span> <span class="n">pb</span><span class="p">)</span>
			<span class="k">return</span>

		<span class="c1"># Otherwise, we are generating heatmaps and unable to use multithreading or multiprocessing</span>
		<span class="k">for</span> <span class="n">slide_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">:</span>
			<span class="n">slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLIDES</span><span class="p">[</span><span class="n">slide_name</span><span class="p">]</span>
			<span class="n">category</span> <span class="o">=</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span>

			<span class="n">pb</span> <span class="o">=</span> <span class="n">progress_bar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">bar_length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">counter_text</span><span class="o">=</span><span class="s1">&#39;tiles&#39;</span><span class="p">)</span>
			<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Working on slide {sfutil.green(slide[&#39;name&#39;])}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>

			<span class="c1"># Load the slide</span>
			<span class="n">whole_slide</span> <span class="o">=</span> <span class="n">SlideReader</span><span class="p">(</span><span class="n">slide</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_PX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_UM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRIDE_DIV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_DIR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_LIST</span><span class="p">,</span> <span class="n">pb</span><span class="o">=</span><span class="n">pb</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">loaded_correctly</span><span class="p">():</span>
				<span class="k">continue</span>

			<span class="c1"># Calculate the final layer weights and logits/predictions</span>
			<span class="n">logits</span><span class="p">,</span> <span class="n">final_layer</span><span class="p">,</span> <span class="n">final_layer_labels</span><span class="p">,</span> <span class="n">logits_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_logits</span><span class="p">(</span><span class="n">whole_slide</span><span class="p">,</span> <span class="n">export_tiles</span><span class="o">=</span><span class="n">export_tiles</span><span class="p">,</span> 
																									<span class="n">final_layer</span><span class="o">=</span><span class="n">save_final_layer</span><span class="p">,</span> 
																									<span class="n">pb</span><span class="o">=</span><span class="n">pb</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">logits</span><span class="p">):</span>
				<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Unable to create heatmap for slide {sfutil.green(slide[&#39;name&#39;])}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span>

			<span class="c1"># Save the results</span>
			<span class="k">if</span> <span class="n">save_heatmaps</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">gen_heatmaps</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">thumb</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_PX</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">save_final_layer</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">export_weights</span><span class="p">(</span><span class="n">final_layer</span><span class="p">,</span> <span class="n">final_layer_labels</span><span class="p">,</span> <span class="n">logits_flat</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">display_heatmaps</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">gen_heatmaps</span><span class="p">(</span><span class="n">slide</span><span class="p">,</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">thumb</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_PX</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Convoluter.export_tiles"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.export_tiles">[docs]</a>	<span class="k">def</span> <span class="nf">export_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
		<span class="n">slide_name</span> <span class="o">=</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
		<span class="n">filetype</span> <span class="o">=</span> <span class="n">slide</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
		<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Exporting tiles for slide </span><span class="si">{slide_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
		
		<span class="c1"># Load the slide	</span>
		<span class="n">whole_slide</span> <span class="o">=</span> <span class="n">SlideReader</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">slide_name</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_PX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZE_UM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRIDE_DIV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_DIR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_LIST</span><span class="p">,</span> <span class="n">pb</span><span class="o">=</span><span class="n">pb</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">loaded_correctly</span><span class="p">():</span>
			<span class="k">return</span> <span class="kc">False</span>
		
		<span class="c1"># Create a generator to tessellate image tiles</span>
		<span class="n">gen_slice</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span><span class="n">export</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">augment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">AUGMENT</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">gen_slice</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No tiles extracted from slide {sfutil.green(slide_name)}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">False</span>

		<span class="c1"># Now iterate through the generator to save the images</span>
		<span class="k">for</span> <span class="n">tile</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">unique</span> <span class="ow">in</span> <span class="n">gen_slice</span><span class="p">():</span> 
			<span class="k">pass</span></div>

<div class="viewcode-block" id="Convoluter.calculate_logits"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.calculate_logits">[docs]</a>	<span class="k">def</span> <span class="nf">calculate_logits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">whole_slide</span><span class="p">,</span> <span class="n">export_tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">final_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Convolutes across a whole slide, returning logits and final layer weights for tessellated image tiles&#39;&#39;&#39;</span>

		<span class="c1"># Create tile coordinate generator</span>
		<span class="n">gen_slice</span><span class="p">,</span> <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">stride_px</span><span class="p">,</span> <span class="n">roi_area_fraction</span> <span class="o">=</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">build_generator</span><span class="p">(</span><span class="n">export</span><span class="o">=</span><span class="n">export_tiles</span><span class="p">)</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">gen_slice</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No tiles extracted from slide {sfutil.green(slide_name)}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>

		<span class="c1"># Generate dataset from the generator</span>
		<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;dataset_input&#39;</span><span class="p">):</span>
			<span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">gen_slice</span><span class="p">,</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">))</span>
			<span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tile_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_function</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
			<span class="n">tile_dataset</span> <span class="o">=</span> <span class="n">tile_dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="n">logits_arr</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">labels_arr</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">x_logits_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_size</span> <span class="o">/</span> <span class="n">stride_px</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="n">y_logits_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_size</span> <span class="o">/</span> <span class="n">stride_px</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="n">total_logits_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_logits_len</span> <span class="o">*</span> <span class="n">y_logits_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">roi_area_fraction</span><span class="p">)</span>

		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">prelogits_arr</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Final layer weights </span>
		<span class="n">logits_arr</span> <span class="o">=</span> <span class="p">[]</span>	<span class="c1"># Logits (predictions) </span>
		<span class="n">unique_arr</span> <span class="o">=</span> <span class="p">[]</span>	<span class="c1"># Boolean array indicating whether tile is unique (non-overlapping) </span>

		<span class="c1"># Iterate through generator to calculate logits +/- final layer weights for all tiles</span>
		<span class="k">for</span> <span class="n">batch_images</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">,</span> <span class="n">batch_unique</span> <span class="ow">in</span> <span class="n">tile_dataset</span><span class="p">:</span>
			<span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">total_logits_count</span><span class="p">)</span>
			<span class="n">prelogits</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">batch_images</span><span class="p">,</span> <span class="n">batch_images</span><span class="p">])</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>
			<span class="n">prelogits_arr</span> <span class="o">=</span> <span class="n">prelogits</span> <span class="k">if</span> <span class="n">prelogits_arr</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">prelogits_arr</span><span class="p">,</span> <span class="n">prelogits</span><span class="p">])</span>
			<span class="n">logits_arr</span> <span class="o">=</span> <span class="n">logits</span> <span class="k">if</span> <span class="n">logits_arr</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">logits_arr</span><span class="p">,</span> <span class="n">logits</span><span class="p">])</span>
			<span class="n">labels_arr</span> <span class="o">=</span> <span class="n">batch_labels</span> <span class="k">if</span> <span class="n">labels_arr</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">labels_arr</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">])</span>
			<span class="n">unique_arr</span> <span class="o">=</span> <span class="n">batch_unique</span> <span class="k">if</span> <span class="n">unique_arr</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">unique_arr</span><span class="p">,</span> <span class="n">batch_unique</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">pb</span><span class="p">:</span> <span class="n">pb</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

		<span class="c1"># Sort the output (may be shuffled due to multithreading)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">labels_arr</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="c1"># This occurs when the list is empty, likely due to an empty annotation area</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No tile calculations performed for this image, are you sure the annotation area isn&#39;t empty?&quot;</span><span class="p">)</span>
		<span class="n">logits_arr</span> <span class="o">=</span> <span class="n">logits_arr</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
		<span class="n">labels_arr</span> <span class="o">=</span> <span class="n">labels_arr</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
		
		<span class="c1"># Perform same functions on final layer weights</span>
		<span class="n">flat_unique_logits</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">final_layer</span><span class="p">:</span>
			<span class="n">prelogits_arr</span> <span class="o">=</span> <span class="n">prelogits_arr</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
			<span class="n">unique_arr</span> <span class="o">=</span> <span class="n">unique_arr</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
			<span class="c1"># Find logits from non-overlapping tiles (will be used for metadata for saved final layer weights CSV)</span>
			<span class="n">flat_unique_logits</span> <span class="o">=</span> <span class="p">[</span><span class="n">logits_arr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logits_arr</span><span class="p">))</span> <span class="k">if</span> <span class="n">unique_arr</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
			<span class="n">prelogits_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">prelogits_arr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prelogits_arr</span><span class="p">))</span> <span class="k">if</span> <span class="n">unique_arr</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span>
			<span class="n">prelogits_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels_arr</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_arr</span><span class="p">))</span> <span class="k">if</span> <span class="n">unique_arr</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">prelogits_out</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="n">prelogits_labels</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># Expand logits back to a full 2D map spanning the whole slide,</span>
		<span class="c1">#  supplying values of &quot;0&quot; where tiles were skipped by the tile generator</span>
		<span class="n">expanded_logits</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">whole_slide</span><span class="o">.</span><span class="n">tile_mask</span><span class="p">)</span>
		<span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expanded_logits</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">whole_slide</span><span class="o">.</span><span class="n">tile_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">expanded_logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logits_arr</span><span class="p">[</span><span class="n">li</span><span class="p">]</span>
				<span class="n">li</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">expanded_logits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">expanded_logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Mismatch with number of categories in model output and expected number of categories&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

		<span class="c1"># Resize logits array into a two-dimensional array for heatmap display</span>
		<span class="n">logits_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">expanded_logits</span><span class="p">,</span> <span class="p">[</span><span class="n">y_logits_len</span><span class="p">,</span> <span class="n">x_logits_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">logits_out</span><span class="p">,</span> <span class="n">prelogits_out</span><span class="p">,</span> <span class="n">prelogits_labels</span><span class="p">,</span> <span class="n">flat_unique_logits</span></div>

<div class="viewcode-block" id="Convoluter.export_weights"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.export_weights">[docs]</a>	<span class="k">def</span> <span class="nf">export_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Exports final layer weights (and logits) for non-overlapping tiles into a CSV file.&#39;&#39;&#39;</span>
		<span class="n">log</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="s2">&quot;Writing csv...&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">csv_started</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="s1">&#39;final_layer_weights.csv&#39;</span><span class="p">))</span>
		<span class="n">write_mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="n">csv_started</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="s1">&#39;final_layer_weights.csv&#39;</span><span class="p">),</span> <span class="n">write_mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
			<span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">csv_started</span><span class="p">:</span>
				<span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;Tile_num&quot;</span><span class="p">,</span> <span class="s2">&quot;Slide&quot;</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;Logits</span><span class="si">{l}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;Node</span><span class="si">{n}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))])</span>
			<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)):</span>
				<span class="n">logit</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
				<span class="n">out</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
				<span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">labels</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="p">]</span> <span class="o">+</span> <span class="n">logit</span> <span class="o">+</span> <span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="Convoluter.gen_heatmaps"><a class="viewcode-back" href="../../slideflow.convoluter.html#slideflow.convoluter.Convoluter.gen_heatmaps">[docs]</a>	<span class="k">def</span> <span class="nf">gen_heatmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">thumbnail</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&#39;&#39;&#39;Displays and/or saves logits as a heatmap overlay.&#39;&#39;&#39;</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

		<span class="n">implot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="n">FastImshow</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tgt_res</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
		<span class="n">im_extent</span> <span class="o">=</span> <span class="n">implot</span><span class="o">.</span><span class="n">get_extent</span><span class="p">()</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="n">implot</span><span class="o">.</span><span class="n">extent</span>
		<span class="n">extent</span> <span class="o">=</span> <span class="n">im_extent</span>

		<span class="n">gca</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
		<span class="n">gca</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

		<span class="c1"># Define color map</span>
		<span class="n">jetMap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">cmMap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">nipy_spectral</span><span class="p">(</span><span class="n">jetMap</span><span class="p">)</span>
		<span class="n">newMap</span> <span class="o">=</span> <span class="n">mcol</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">cmMap</span><span class="p">)</span>

		<span class="n">heatmap_dict</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="k">def</span> <span class="nf">slider_func</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">heatmap_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="n">h</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

		<span class="c1"># Make heatmaps and sliders</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span><span class="p">):</span>
			<span class="n">heatmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">logits</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">newMap</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1">#bicubic</span>
			<span class="k">if</span> <span class="n">save</span><span class="p">:</span>
				<span class="n">heatmap_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">heatmap</span><span class="p">})</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">ax_slider</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="o">-</span><span class="p">(</span><span class="mf">0.2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgoldenrodyellow&#39;</span><span class="p">)</span>
				<span class="n">slider</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">ax_slider</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Class </span><span class="si">{i}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">valinit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">heatmap_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="s2">&quot;Class</span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">slider</span><span class="p">]})</span>
				<span class="n">slider</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="n">slider_func</span><span class="p">)</span>

		<span class="c1"># Save of display heatmap overlays</span>
		<span class="k">if</span> <span class="n">save</span><span class="p">:</span>
			<span class="n">mp</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">-raw.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CLASSES</span><span class="p">):</span>
				<span class="n">heatmap_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
				<span class="n">mp</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAVE_FOLDER</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">-</span><span class="si">{i}</span><span class="s1">.png&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
				<span class="n">heatmap_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
			<span class="n">mp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="n">log</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saved heatmaps for {sfutil.green(slide[&#39;name&#39;])}&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="n">implot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
			<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, James M Dolezal

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>